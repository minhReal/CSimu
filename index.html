<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trading Simulation</title>
    <style>
        /* GIAO DI·ªÜN C≈® (DARK THEME) */
        body { margin: 0; background: #000; overflow: hidden; font-family: Arial, sans-serif; color: white; }
        * { touch-action: manipulation; user-select: none; box-sizing: border-box; }
        
        /* M√†n h√¨nh Login */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .login-box {
            background: #0d1117; padding: 20px; border-radius: 14px;
            width: 85%; max-width: 350px; border: 1px solid #30363d;
            box-shadow: 0 0 25px black; text-align: center;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 15px 0;
            background: #161b22; border: 1px solid #30363d;
            color: #00ff88; border-radius: 6px; font-size: 16px; outline: none; text-align: center;
        }
        .btn-row { display: flex; gap: 10px; }
        .btn-auth {
            flex: 1; padding: 12px; border: none; border-radius: 6px; 
            font-weight: bold; cursor: pointer; color: white;
        }
        
        /* Giao di·ªán ch√≠nh */
        #game-ui { 
            display: none; position: fixed; top: 20px; left: 10px; right: 10px; margin: auto;
            max-width: 450px; background: #0d1117; border-radius: 14px;
            box-shadow: 0 0 25px black; overflow: hidden; border: 1px solid #30363d;
        }
        
        .header { 
            background: #161b22; padding: 12px; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 1px solid #30363d; 
        }
        
        .news-bar {
            background: #0b0e11; padding: 8px 12px; font-size: 12px; 
            color: #8b949e; border-bottom: 1px solid #21262d;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .chart-area { padding: 10px; background: #0b0e11; position: relative; }
        canvas { width: 100%; height: 220px; background: #161b22; border: 1px solid #30363d; border-radius: 8px; }

        .controls { padding: 15px; background: #161b22; border-top: 1px solid #30363d; }
        
        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 13px; font-weight: bold; }
        
        .trade-box { display: flex; gap: 8px; align-items: center; }
        .input-money { 
            flex: 1; padding: 10px; background: #0d1117; color: white; 
            border: 1px solid #30363d; border-radius: 6px; font-size: 14px; 
        }
        .btn-trade { padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; }
        
        /* M√†u s·∫Øc */
        .color-up { color: #00ff88; }
        .color-down { color: #ff3b3b; }
        .bg-up { background: #238636; }
        .bg-down { background: #da3633; }
        .bg-blue { background: #1f6feb; }
        .bg-gray { background: #30363d; }

    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="margin: 0 0 5px 0; color: #00ff88;">TRADING SIM</h2>
        <p style="color:#8b949e; font-size: 12px; margin-bottom: 20px;">K·∫øt n·ªëi m√°y ch·ªß to√†n c·∫ßu</p>
        
        <input type="text" id="username" class="login-input" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i...">
        
        <div class="btn-row">
            <button onclick="auth('login')" class="btn-auth bg-blue">ƒêƒÇNG NH·∫¨P</button>
            <button onclick="auth('register')" class="btn-auth bg-gray">ƒêƒÇNG K√ù</button>
        </div>
        <p id="login-msg" style="color: #ff3b3b; font-size: 12px; margin-top: 10px; height: 15px;"></p>
    </div>
</div>

<div id="game-ui">
    <div class="header">
        <div style="font-weight: bold;">Market Index</div>
        <div id="live-price" style="font-weight: bold; font-size: 18px;">---</div>
    </div>

    <div class="news-bar">
        <marquee scrollamount="4" id="news-text">üì∞ ƒêang t·∫£i d·ªØ li·ªáu th·ªã tr∆∞·ªùng...</marquee>
    </div>

    <div class="chart-area">
        <canvas id="chart"></canvas>
    </div>

    <div class="controls">
        <div class="info-row">
            <span style="color: #e6edf3;">Ti·ªÅn: <span id="cash" class="color-up">1000.00</span></span>
            <span style="color: #e6edf3;">T√†i s·∫£n: <span id="asset">0.00</span></span>
        </div>
        
        <div class="trade-box">
            <input type="number" id="amount" class="input-money" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng...">
            <button class="btn-trade bg-up" onclick="trade('buy')">MUA</button>
            <button class="btn-trade bg-down" onclick="trade('sell')">B√ÅN</button>
        </div>
    </div>
</div>

<script>
    // ================= C·∫§U H√åNH =================
    const SERVER_URL = "https://oia.duongminhminh46.workers.dev/";
    // ============================================

    let username = "";
    let wallet = { cash: 1000, asset: 0 };
    let candles = [];
    let currentPrice = 0;
    let basePrice = 1000; // Gi√° g·ªëc ƒë·ªÉ v·∫Ω thanh ngang
    let chartCtx, canvas;

    // --- X·ª¨ L√ù ƒêƒÇNG NH·∫¨P / ƒêƒÇNG K√ù ---
    function auth(type) {
        const name = document.getElementById("username").value.trim();
        const msg = document.getElementById("login-msg");
        
        if (!name) { msg.innerText = "Vui l√≤ng nh·∫≠p t√™n!"; return; }

        // Ki·ªÉm tra d·ªØ li·ªáu trong m√°y (LocalStorage)
        const savedData = localStorage.getItem(`tradegame_${name}`);

        if (type === 'login') {
            if (savedData) {
                wallet = JSON.parse(savedData);
                enterGame(name);
            } else {
                msg.innerText = "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i!";
            }
        } else if (type === 'register') {
            if (savedData) {
                msg.innerText = "T√™n n√†y ƒë√£ c√≥ ng∆∞·ªùi d√πng!";
            } else {
                // T·∫°o m·ªõi
                wallet = { cash: 1000, asset: 0 };
                saveGame(name);
                enterGame(name);
            }
        }
    }

    function enterGame(name) {
        username = name;
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("game-ui").style.display = "block";
        
        initChart();
        updateUI();
        
        // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p k·∫øt n·ªëi Server
        setInterval(fetchServer, 1000);
        fetchServer();
    }

    function saveGame(name) {
        localStorage.setItem(`tradegame_${name || username}`, JSON.stringify(wallet));
    }

    // --- K·∫æT N·ªêI SERVER ---
    async function fetchServer() {
        try {
            const res = await fetch(SERVER_URL);
            const data = await res.json();
            
            // C·∫≠p nh·∫≠t gi√° & n·∫øn
            currentPrice = data.price;
            
            // X·ª≠ l√Ω n·∫øn (Ch·ªëng spam n·∫øn tr√πng)
            const newCandle = data.candle;
            if (candles.length === 0 || candles[candles.length-1].time !== newCandle.time) {
                candles.push(newCandle);
                if (candles.length > 35) candles.shift();
            } else {
                candles[candles.length-1] = newCandle;
            }

            // X·ª≠ l√Ω tin t·ª©c (N·∫øu server c√≥ g·ª≠i v·ªÅ)
            // N·∫øu server ch∆∞a tr·∫£ v·ªÅ tin, ta t·ª± random tin gi·∫£ l·∫≠p ƒë·ªÉ UI kh√¥ng b·ªã ch·∫øt
            if(data.news) {
                 document.getElementById("news-text").innerText = "üì∞ " + data.news;
            } else {
                 // Fallback tin t·ª©c n·∫øu server ch∆∞a update code tin
                 const fallbackNews = ["Th·ªã tr∆∞·ªùng ·ªïn ƒë·ªãnh", "L·ª±c mua ƒëang tƒÉng", "Kh·ªëi l∆∞·ª£ng giao d·ªãch th·∫•p", "Bi·∫øn ƒë·ªông m·∫°nh"];
                 if(Math.random() < 0.05) {
                    document.getElementById("news-text").innerText = "üì∞ " + fallbackNews[Math.floor(Math.random()*fallbackNews.length)];
                 }
            }

            drawChart();
            updateUI();

        } catch (e) {
            console.error("L·ªói k·∫øt n·ªëi");
        }
    }

    // --- V·∫º BI·ªÇU ƒê·ªí (C√ì THANH NGANG) ---
    function initChart() {
        canvas = document.getElementById("chart");
        const box = document.querySelector(".chart-area");
        // Fix ƒë·ªô n√©t
        const dpr = window.devicePixelRatio || 1;
        canvas.width = box.clientWidth * dpr;
        canvas.height = 220 * dpr;
        chartCtx = canvas.getContext("2d");
        chartCtx.scale(dpr, dpr);
    }

    function drawChart() {
        if (candles.length === 0) return;

        const W = canvas.width / (window.devicePixelRatio || 1);
        const H = 220; // Height c·ªë ƒë·ªãnh CSS

        chartCtx.clearRect(0, 0, W, H);

        // T√¨m Min/Max ƒë·ªÉ scale
        let min = Infinity, max = -Infinity;
        candles.forEach(c => {
            if (c.low < min) min = c.low;
            if (c.high > max) max = c.high;
        });
        
        // M·ªü r·ªông bi√™n ƒë·ªô ƒë·ªÉ h√¨nh kh√¥ng s√°t l·ªÅ
        const range = max - min || 1;
        const padding = 20;
        
        // H√†m chuy·ªÉn ƒë·ªïi Gi√° -> T·ªça ƒë·ªô Y
        const getY = (val) => H - padding - ((val - min) / range) * (H - padding*2);

        // 1. V·∫º THANH NGANG (M·ªêC GI√Å G·ªêC 1000)
        // ƒê√¢y l√† c√°i b·∫°n y√™u c·∫ßu ƒë·ªÉ ph√¢n bi·ªát l√£i l·ªó
        const baseLineY = getY(1000); 
        chartCtx.strokeStyle = "#555"; // M√†u x√°m
        chartCtx.lineWidth = 1;
        chartCtx.setLineDash([5, 5]); // N√©t ƒë·ª©t
        chartCtx.beginPath();
        chartCtx.moveTo(0, baseLineY);
        chartCtx.lineTo(W, baseLineY);
        chartCtx.stroke();
        chartCtx.setLineDash([]); // Reset n√©t li·ªÅn
        
        // V·∫Ω th√™m ch·ªØ "1000" ·ªü c·∫°nh d√≤ng k·∫ª
        chartCtx.fillStyle = "#555";
        chartCtx.font = "10px Arial";
        chartCtx.fillText("M·ªëc 1000", 5, baseLineY - 5);

        // 2. V·∫º N·∫æN
        const candleW = (W - 20) / 35; 
        const gap = 2;

        candles.forEach((c, i) => {
            const x = i * candleW + 5;
            const openY = getY(c.open);
            const closeY = getY(c.close);
            const highY = getY(c.high);
            const lowY = getY(c.low);

            const isUp = c.close >= c.open;
            const color = isUp ? "#00ff88" : "#ff3b3b"; // M√†u xanh/ƒë·ªè c≈©

            chartCtx.fillStyle = color;
            chartCtx.strokeStyle = color;

            // R√¢u n·∫øn
            chartCtx.beginPath();
            chartCtx.moveTo(x + candleW/2, highY);
            chartCtx.lineTo(x + candleW/2, lowY);
            chartCtx.stroke();

            // Th√¢n n·∫øn
            const hBody = Math.abs(closeY - openY) < 1 ? 1 : Math.abs(closeY - openY);
            chartCtx.fillRect(x + gap, Math.min(openY, closeY), candleW - gap*2, hBody);
        });
    }

    // --- GIAO D·ªäCH & UI ---
    function trade(type) {
        const input = document.getElementById("amount");
        const val = parseFloat(input.value);

        if (!val || val <= 0) return;

        if (type === 'buy') {
            if (val > wallet.cash) return alert("Kh√¥ng ƒë·ªß ti·ªÅn!");
            wallet.asset += val / currentPrice;
            wallet.cash -= val;
        } else {
            const assetNeeded = val / currentPrice;
            if (assetNeeded > wallet.asset) return alert("Kh√¥ng ƒë·ªß t√†i s·∫£n!");
            wallet.asset -= assetNeeded;
            wallet.cash += val;
        }

        input.value = "";
        saveGame();
        updateUI();
    }

    function updateUI() {
        // C·∫≠p nh·∫≠t gi√°
        const pEl = document.getElementById("live-price");
        pEl.innerText = currentPrice.toFixed(2);
        
        const lastCandle = candles[candles.length-1];
        if (lastCandle) {
            pEl.style.color = lastCandle.close >= lastCandle.open ? "#00ff88" : "#ff3b3b";
        }

        // C·∫≠p nh·∫≠t v√≠
        document.getElementById("cash").innerText = wallet.cash.toFixed(2);
        document.getElementById("asset").innerText = wallet.asset.toFixed(4);
    }
    
    // Resize chart khi xoay m√†n h√¨nh
    window.onresize = initChart;

</script>
</body>
</html>
