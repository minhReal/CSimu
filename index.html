<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal X - Admin Edition</title>
    
    <script>
        // 1. Ch·∫∑n Menu Chu·ªôt Ph·∫£i
        document.addEventListener('contextmenu', event => event.preventDefault());

        // 2. Ch·∫∑n Ph√≠m T·∫Øt (F12, Ctrl+U, Ctrl+Shift+I...)
        document.onkeydown = function(e) {
            // F12
            if(e.keyCode == 123) return false;
            // Ctrl+Shift+I (DevTools)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            // Ctrl+Shift+J (Console)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
            // Ctrl+Shift+C (Inspect)
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
            // Ctrl+U (View Source)
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        }

        // 3. B·∫´y Debugger (Treo tr√¨nh duy·ªát n·∫øu c·ªë t√¨nh m·ªü DevTool)
        // setInterval(() => { debugger; }, 200); 
        // (L∆∞u √Ω: ƒê√£ t·∫°m t·∫Øt d√≤ng tr√™n ƒë·ªÉ b·∫°n test. Khi n√†o ch·∫°y th·∫≠t h√£y b·ªè comment // ra)
    </script>

    <style>
        /* --- GIAO DI·ªÜN CH√çNH (THEME) --- */
        :root { 
            --bg: #050505; 
            --panel: #121212; 
            --border: #2a2a2a; 
            --green: #00ff88; 
            --red: #ff3b3b; 
            --gold: #ffd700;
            --text-main: #e0e0e0; 
            --text-dim: #888;
        }

        body { margin: 0; background: var(--bg); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; height: 100dvh; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        button { cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        
        /* Layout Container */
        #app { display: none; height: 100dvh; flex-direction: column; }
        
        /* --- M√ÄN H√åNH ƒêƒÇNG NH·∫¨P --- */
        #login-screen { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { background: var(--panel); border: 1px solid var(--border); padding: 30px; border-radius: 16px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 0 50px rgba(0,255,136,0.1); }
        .inp-auth { width: 100%; padding: 15px; margin: 10px 0; background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 8px; font-size: 16px; text-align: center; outline: none; }
        .btn-auth { width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; color: white; }
        
        /* --- HEADER & NAVIGATION --- */
        .header { padding: 12px 15px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .tab-bar { display: flex; border-bottom: 1px solid var(--border); background: var(--panel); flex-shrink: 0; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; font-size: 12px; font-weight: bold; color: var(--text-dim); cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--green); border-bottom-color: var(--green); background: #1a1a1a; color: white; }
        
        /* --- KHUNG HI·ªÇN TH·ªä N·ªòI DUNG --- */
        .view-content { flex: 1; overflow-y: auto; position: relative; }
        .hidden { display: none !important; }

        /* --- DANH S√ÅCH C·ªî PHI·∫æU --- */
        .stock-item { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 16px; margin: 10px; border-radius: 10px; border: 1px solid var(--border); cursor: pointer; }
        .stock-item:hover { background: #222; }

        /* --- B·∫¢NG X·∫æP H·∫†NG --- */
        .rank-item { display: flex; align-items: center; background: #161616; padding: 12px; margin: 8px 10px; border-radius: 8px; border: 1px solid var(--border); }
        .rank-me { border: 1px solid var(--green); background: #0f3318; }
        .rank-num { width: 30px; font-weight: 900; font-size: 16px; color: #666; text-align: center; }
        .rank-1 { color: var(--gold); text-shadow: 0 0 10px rgba(255,215,0,0.5); font-size: 18px; }
        
        /* --- ADMIN PANEL STYLE --- */
        #admin-view { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; }
        .admin-header { padding: 15px; background: #2a0505; color: var(--red); font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--red); }
        .admin-section { padding: 15px; border-bottom: 1px solid #333; }
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #222; }
        .btn-del { background: var(--red); color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: bold; }

        /* --- CHI TI·∫æT C·ªî PHI·∫æU (CHART) --- */
        #detail-view { display: none; flex: 1; flex-direction: column; background: #000; z-index: 100; position: fixed; inset: 0; }
        .chart-header { padding: 10px 15px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .chart-container { flex: 1; width: 100%; min-height: 200px; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* D√≤ng tin t·ª©c ch·∫°y trong Chart */
        .mini-news { background: #0a0a0a; border-bottom: 1px solid #333; padding: 8px; font-size: 12px; color: #aaa; white-space: nowrap; overflow: hidden; border-left: 3px solid var(--green); }
        
        /* News Card */
        .news-card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 12px; margin: 10px; border-left: 4px solid #555; }
        
        /* Settings Modal */
        #settings-modal { position: fixed; inset: 0; z-index: 5000; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; }
        .settings-box { background: var(--panel); border: 1px solid var(--border); padding: 20px; border-radius: 12px; width: 80%; max-width: 300px; }

        /* M√†u s·∫Øc ti·ªán √≠ch */
        .up { color: var(--green); } 
        .down { color: var(--red); }
    </style>
</head>
<body>

<audio id="bgm" loop>
    <source src="https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3" type="audio/mpeg">
</audio>

<div id="login-screen">
    <div class="login-box">
        <h2 style="margin:0 0 20px 0; color:var(--green); letter-spacing:1px;">TERMINAL X</h2>
        <input type="text" id="user" class="inp-auth" placeholder="T√™n hi·ªÉn th·ªã (minh = admin)">
        <input type="password" id="pass" class="inp-auth" placeholder="M·∫≠t m√£ b√≠ m·∫≠t">
        <button onclick="handleAuth('login')" class="btn-auth" style="background:#1f6feb;">ƒêƒÇNG NH·∫¨P</button>
        <button onclick="handleAuth('register')" class="btn-auth" style="background:#238636;">ƒêƒÇNG K√ù M·ªöI</button>
        <div id="msg" style="color:var(--red); font-size:12px; margin-top:15px; min-height:20px;"></div>
    </div>
</div>

<div id="app">
    <div class="header">
        <div style="font-weight:bold; display:flex; align-items:center; gap:5px;">
            üë§ <span id="u-name" style="color:#ccc">...</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button id="btn-admin" onclick="openAdmin()" style="display:none; background:var(--red); color:white; border:none; padding:6px 10px; border-radius:4px; font-size:10px; font-weight:bold; letter-spacing:1px;">ADMIN PANEL</button>
            
            <div style="font-weight:bold; color:var(--green); background:#0f3318; padding:5px 10px; border-radius:6px;">
                $<span id="cash-display">0.00</span>
            </div>
            <button onclick="openSettings()" style="background:none; border:none; font-size:20px; color:#888;">‚öôÔ∏è</button>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-btn active" onclick="switchTab('market')">TH·ªä TR∆Ø·ªúNG</div>
        <div class="tab-btn" onclick="switchTab('rank')">X·∫æP H·∫†NG</div>
        <div class="tab-btn" onclick="switchTab('news')">TIN T·ª®C</div>
    </div>

    <div id="tab-market" class="view-content">
        <div id="stock-list-container" style="padding-bottom:20px;">
            <div style="text-align:center; padding:20px; color:#666;">ƒêang t·∫£i d·ªØ li·ªáu v·ªá tinh...</div>
        </div>
    </div>

    <div id="tab-rank" class="view-content hidden">
        <div style="text-align:center; padding:10px; font-size:11px; color:#666; border-bottom:1px solid #222;">B·∫¢NG X·∫æP H·∫†NG REAL-TIME (SERVER)</div>
        <div id="rank-list-container" style="padding:10px;"></div>
    </div>

    <div id="tab-news" class="view-content hidden">
        <div id="news-list-container" style="padding:10px;"></div>
    </div>
</div>

<div id="admin-view">
    <div class="admin-header">
        <span>QU·∫¢N TR·ªä VI√äN (MASTER)</span>
        <button onclick="document.getElementById('admin-view').style.display='none'" style="background:#440000; color:#ffaaaa; border:1px solid var(--red); padding:5px 12px; border-radius:4px; font-weight:bold;">ƒê√ìNG</button>
    </div>
    
    <div class="view-content" style="padding-bottom:50px;">
        <div class="admin-section">
            <h4 style="margin:0 0 10px 0; color:#aaa;">QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG</h4>
            <button onclick="loadAdminUsers()" style="background:#333; color:white; border:none; padding:10px; width:100%; border-radius:4px; margin-bottom:10px; font-weight:bold;">üîÑ L√ÄM M·ªöI DANH S√ÅCH</button>
            <div id="admin-user-list" style="max-height: 200px; overflow-y: auto; background: #111; border-radius: 8px;">ƒêang t·∫£i...</div>
        </div>
        
        <div class="admin-section">
            <h4 style="margin:0 0 10px 0; color:#aaa;">THAO T√öNG TH·ªä TR∆Ø·ªúNG (MARKET MAKER)</h4>
            <div style="background: #111; padding:15px; border-radius:8px;">
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <select id="adm-stock" class="inp-auth" style="padding:8px; margin:0; flex:1; text-align:left;">
                        <option value="VN-INDEX">VN-INDEX</option>
                        <option value="VIN">VIN (Vingroup)</option>
                        <option value="FPT">FPT Corp</option>
                        <option value="DIG">DIG Corp</option>
                        <option value="HPG">H√≤a Ph√°t</option>
                    </select>
                    <select id="adm-action" class="inp-auth" style="padding:8px; margin:0; flex:1; text-align:left;">
                        <option value="pump">PUMP (ƒê·∫©y gi√°)</option>
                        <option value="dump">DUMP (ƒê·∫°p gi√°)</option>
                    </select>
                </div>
                <button onclick="adminAction()" style="width:100%; background:var(--gold); color:black; border:none; padding:12px; font-weight:bold; border-radius:4px; font-size:14px;">TH·ª∞C THI L·ªÜNH</button>
                <p style="font-size:10px; color:#666; margin-top:5px; text-align:center;">*H√†nh ƒë·ªông n√†y s·∫Ω tung tin ƒë·ªìn gi·∫£ l·∫≠p ƒë·ªÉ t√°c ƒë·ªông t√¢m l√Ω.</p>
            </div>
        </div>
    </div>
</div>

<div id="settings-modal" onclick="if(event.target.id==='settings-modal') this.style.display='none'">
    <div class="settings-box">
        <h3 style="text-align:center; margin-top:0;">C√ÄI ƒê·∫∂T</h3>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:15px;">
            <span>Nh·∫°c n·ªÅn (BGM)</span>
            <input type="checkbox" id="toggle-bgm" checked onchange="toggleAudio()">
        </div>
        
        <button onclick="logout()" style="width:100%; padding:12px; background:#da3633; color:white; border:none; border-radius:6px; font-weight:bold;">ƒêƒÇNG XU·∫§T</button>
        <div style="text-align:center; margin-top:10px; font-size:11px; color:#666;">Version 2.5 - Admin Edition</div>
    </div>
</div>

<div id="detail-view">
    <div class="chart-header">
        <button onclick="closeDetail()" style="background:#333; color:white; border:none; padding:6px 16px; border-radius:6px; font-weight:bold;">‚óÄ TR·ªû V·ªÄ</button>
        <div style="flex:1; text-align:center;">
            <div id="d-code" style="font-weight:900; font-size:18px;">CODE</div>
            <div style="font-size:11px; color:#888;">ƒêang s·ªü h·ªØu: <span id="d-owned" style="color:white; font-weight:bold;">0</span></div>
        </div>
        <div style="text-align: right;">
            <div id="d-price" style="font-size:20px; font-weight: bold;">0.00</div>
        </div>
    </div>
    
    <div class="mini-news" id="mini-news-ticker">üì∞ ƒêang c·∫≠p nh·∫≠t tin t·ª©c th·ªã tr∆∞·ªùng...</div>

    <div class="chart-container">
        <canvas id="chart"></canvas>
    </div>
    
    <div style="padding:20px; background:#111; border-top:1px solid #333;">
        <input type="number" id="trade-amount" class="inp-auth" placeholder="Nh·∫≠p s·ªë ti·ªÅn ($)" style="margin-bottom:15px; font-size:20px; font-weight:bold;">
        <div style="display:flex; gap:10px;">
            <button onclick="trade('buy')" class="btn-auth" style="margin:0; background:#238636; height:50px;">MUA</button>
            <button onclick="trade('sell')" class="btn-auth" style="margin:0; background:#da3633; height:50px;">B√ÅN</button>
        </div>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH SERVER ---
    // Thay ƒë·ªïi URL n√†y n·∫øu b·∫°n ƒë·ªïi Worker kh√°c
    const SERVER_URL = "https://oia.duongminhminh46.workers.dev/"; 
    const NEWS_JSON_URL = "https://raw.githubusercontent.com/minhReal/CSimu/refs/heads/main/news.json";

    // --- BI·∫æN TO√ÄN C·ª§C ---
    let currentUser = null;
    let wallet = { cash: 250, stocks: {} };
    let marketData = [];
    let candlesCache = {};
    let selectedStock = null;
    let newsList = [];
    const bgm = document.getElementById("bgm"); 
    bgm.volume = 0.3; // √Çm l∆∞·ª£ng v·ª´a ph·∫£i

    // --- KH·ªûI T·∫†O T·ª∞ ƒê·ªòNG ---
    (function init() {
        const session = localStorage.getItem("current_session");
        if (session && localStorage.getItem(`user_db_${session}`)) {
            currentUser = session;
            wallet = JSON.parse(localStorage.getItem(`user_db_${session}`));
            enterApp();
        }
    })();

    // --- H·ªÜ TH·ªêNG X√ÅC TH·ª∞C (AUTH) ---
    async function handleAuth(type) {
        const u = document.getElementById("user").value.trim();
        const p = document.getElementById("pass").value.trim();
        const msg = document.getElementById("msg");
        
        if (!u || !p) { msg.innerText = "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!"; return; }
        const key = `user_db_${u}`;

        // ƒêƒÇNG K√ù
        if (type === 'register') {
            msg.innerText = "ƒêang ki·ªÉm tra m√°y ch·ªß...";
            try {
                // Ki·ªÉm tra tr√πng t√™n tr√™n Server Cloudflare
                const checkRes = await fetch(`${SERVER_URL}check-user?u=${encodeURIComponent(u)}`);
                const checkData = await checkRes.json();
                
                if (checkData.exists || localStorage.getItem(key)) {
                    msg.innerText = "T√™n n√†y ƒë√£ c√≥ ng∆∞·ªùi d√πng!";
                    msg.style.color = "var(--red)";
                    return;
                }
                
                // T·∫°o m·ªõi
                localStorage.setItem(key, JSON.stringify({ pass: p, cash: 250, stocks: {} }));
                msg.innerText = "ƒêƒÉng k√Ω th√†nh c√¥ng! V·ªën c·∫•p: $250";
                msg.style.color = "var(--green)";
            } catch (e) {
                msg.innerText = "L·ªói k·∫øt n·ªëi Server!";
            }
        } 
        // ƒêƒÇNG NH·∫¨P
        else {
            const userData = JSON.parse(localStorage.getItem(key));
            if (!userData || userData.pass !== p) {
                msg.innerText = "Sai t√™n ho·∫∑c m·∫≠t kh·∫©u!";
                msg.style.color = "var(--red)";
                return;
            }
            currentUser = u;
            wallet = userData;
            localStorage.setItem("current_session", u);
            enterApp();
        }
    }

    function enterApp() {
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("app").style.display = "flex";
        document.getElementById("u-name").innerText = currentUser;

        // K√çCH HO·∫†T ADMIN MODE N·∫æU L√Ä "minh"
        if (currentUser.toLowerCase() === 'minh') {
            document.getElementById("btn-admin").style.display = "block";
        }

        // B·∫≠t nh·∫°c n·∫øu ƒë∆∞·ª£c ph√©p
        if (document.getElementById("toggle-bgm").checked) bgm.play().catch(()=>{});

        // V√≤ng l·∫∑p d·ªØ li·ªáu
        fetchData(); // G·ªçi ngay l·∫≠p t·ª©c
        setInterval(fetchData, 1500); // C·∫≠p nh·∫≠t gi√° m·ªói 1.5s
        setInterval(syncRankToServer, 3000); // ƒê·ªìng b·ªô ƒëi·ªÉm l√™n server m·ªói 3s
        setInterval(fetchLeaderboard, 5000); // L·∫•y BXH m·ªói 5s
        setInterval(updateMiniTicker, 4000); // Ch·∫°y ch·ªØ tin t·ª©c
        loadNewsData(); // T·∫£i tin t·ª©c
    }

    // --- H·ªÜ TH·ªêNG ADMIN ---
    function openAdmin() {
        document.getElementById("admin-view").style.display = "flex";
        loadAdminUsers();
    }

    async function loadAdminUsers() {
        const container = document.getElementById("admin-user-list");
        container.innerHTML = `<div style="padding:10px; color:#666;">ƒêang t·∫£i d·ªØ li·ªáu...</div>`;
        try {
            const res = await fetch(`${SERVER_URL}admin/users`);
            const users = await res.json();
            
            if (users.length === 0) {
                container.innerHTML = `<div style="padding:10px; color:#666;">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o.</div>`;
                return;
            }

            container.innerHTML = users.map(u => `
                <div class="user-row">
                    <div>
                        <div style="font-weight:bold; color:white; font-size:14px;">${u.name}</div>
                        <div style="font-size:11px; color:#888;">T·ªïng t√†i s·∫£n: <span style="color:var(--green)">$${parseFloat(u.asset).toLocaleString()}</span></div>
                    </div>
                    ${u.name.toLowerCase() !== 'minh' ? 
                      `<button class="btn-del" onclick="deleteUser('${u.name}')">X√ìA</button>` : 
                      '<span style="font-size:10px; color:var(--gold); font-weight:bold;">MASTER</span>'}
                </div>
            `).join('');
        } catch (e) {
            container.innerHTML = `<div style="padding:10px; color:var(--red);">L·ªói k·∫øt n·ªëi Server!</div>`;
        }
    }

    async function deleteUser(targetName) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n: ${targetName}?`)) return;
        try {
            await fetch(`${SERVER_URL}admin/delete-user`, {
                method: "POST",
                body: JSON.stringify({ user: targetName })
            });
            alert("ƒê√£ x√≥a th√†nh c√¥ng!");
            loadAdminUsers(); // T·∫£i l·∫°i danh s√°ch
        } catch (e) { alert("L·ªói khi x√≥a!"); }
    }

    function adminAction() {
        const stock = document.getElementById("adm-stock").value;
        const action = document.getElementById("adm-action").value;
        const msg = action === 'pump' ? "TIN M·∫¨T: C√° m·∫≠p ƒëang gom h√†ng ƒë·∫©y gi√°!" : "TIN M·∫¨T: Ch·ªß t·ªãch b√°n chui c·ªï phi·∫øu!";
        const impact = action === 'pump' ? 50 : -50;
        
        // Th√™m tin gi·∫£ v√†o danh s√°ch tin t·ª©c c·ªßa m√°y kh√°ch
        newsList.unshift({ t: `[ADMIN LEAK] ${stock}: ${msg}`, b: impact });
        
        alert(`ƒê√£ th·ª±c thi l·ªánh ${action.toUpperCase()} l√™n m√£ ${stock}.\nTin ƒë·ªìn ƒë√£ ƒë∆∞·ª£c tung ra th·ªã tr∆∞·ªùng!`);
        updateMiniTicker(); // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
    }

    // --- CORE LOGIC (TH·ªä TR∆Ø·ªúNG) ---
    async function fetchData() {
        try {
            const res = await fetch(SERVER_URL);
            const json = await res.json();
            marketData = json.stocks;

            // X·ª≠ l√Ω n·∫øn (Candles)
            marketData.forEach(s => {
                if (!candlesCache[s.code]) candlesCache[s.code] = [];
                const list = candlesCache[s.code];
                // N·∫øu n·∫øn m·ªõi (th·ªùi gian kh√°c)
                if (list.length === 0 || list[list.length - 1].time !== s.candle.time) {
                    list.push(s.candle);
                    if (list.length > 50) list.shift(); // Gi·ªØ 50 n·∫øn g·∫ßn nh·∫•t
                } else {
                    // C·∫≠p nh·∫≠t n·∫øn hi·ªán t·∫°i
                    list[list.length - 1] = s.candle;
                }
            });

            if (!selectedStock) renderMarketList();
            else {
                updateDetailData();
                drawChart();
            }
            
            document.getElementById("cash-display").innerText = wallet.cash.toFixed(2);
        } catch (e) { console.error("Fetch error", e); }
    }

    function renderMarketList() {
        const container = document.getElementById("stock-list-container");
        container.innerHTML = marketData.map(s => {
            const isUp = s.candle.close >= s.candle.open;
            const owned = wallet.stocks[s.code] || 0;
            return `
            <div class="stock-item" onclick="openDetail('${s.code}')">
                <div>
                    <div style="font-weight:900; font-size:16px; color:white;">${s.code}</div>
                    <div style="font-size:11px; color:#888;">ƒêang c√≥: ${owned.toFixed(1)}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:16px; font-weight:bold; color:${isUp ? 'var(--green)' : 'var(--red)'}">
                        ${s.price.toFixed(2)}
                    </div>
                    <div style="font-size:10px; color:#666;">${isUp ? '‚ñ≤ TƒÉng' : '‚ñº Gi·∫£m'}</div>
                </div>
            </div>`;
        }).join('');
    }

    // --- X·∫æP H·∫†NG (REAL-TIME) ---
    async function syncRankToServer() {
        if (!currentUser) return;
        let totalAsset = wallet.cash;
        marketData.forEach(s => {
            if (wallet.stocks[s.code]) totalAsset += wallet.stocks[s.code] * s.price;
        });

        try {
            await fetch(`${SERVER_URL}update-rank`, {
                method: "POST",
                body: JSON.stringify({ user: currentUser, asset: totalAsset })
            });
        } catch (e) {}
    }

    async function fetchLeaderboard() {
        if (document.getElementById("tab-rank").classList.contains("hidden")) return;
        try {
            const res = await fetch(`${SERVER_URL}get-rank`);
            const list = await res.json();
            const container = document.getElementById("rank-list-container");
            
            container.innerHTML = list.map((p, i) => `
                <div class="rank-item ${p.name === currentUser ? 'rank-me' : ''}">
                    <div class="rank-num ${i === 0 ? 'rank-1' : ''}">${i + 1}</div>
                    <div style="flex:1; margin-left:10px;">
                        <div style="font-weight:bold; color:white; font-size:14px;">
                            ${p.name} ${i === 0 ? 'üëë' : ''}
                        </div>
                        <div style="font-size:12px; color:#888;">
                            T·ªïng TS: <span style="color:#ddd">$${p.total.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (e) {}
    }

    // --- GIAO D·ªäCH (TRADE) ---
    function openDetail(code) {
        selectedStock = code;
        document.getElementById("detail-view").style.display = "flex";
        initChart();
        updateDetailData();
        updateMiniTicker();
    }

    function closeDetail() {
        selectedStock = null;
        document.getElementById("detail-view").style.display = "none";
        renderMarketList();
    }

    function updateDetailData() {
        const s = marketData.find(x => x.code === selectedStock);
        if (s) {
            document.getElementById("d-code").innerText = s.code;
            document.getElementById("d-price").innerText = s.price.toFixed(2);
            document.getElementById("d-owned").innerText = (wallet.stocks[selectedStock] || 0).toFixed(2);
            
            const lastCandle = candlesCache[selectedStock]?.at(-1);
            const color = (lastCandle && lastCandle.close >= lastCandle.open) ? "var(--green)" : "var(--red)";
            document.getElementById("d-price").style.color = color;
        }
    }

    function trade(type) {
        const input = document.getElementById("trade-amount");
        const amount = parseFloat(input.value);
        if (!amount || amount <= 0) return alert("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!");

        const stock = marketData.find(s => s.code === selectedStock);
        if (type === 'buy') {
            if (amount > wallet.cash) return alert("Kh√¥ng ƒë·ªß ti·ªÅn m·∫∑t!");
            wallet.cash -= amount;
            wallet.stocks[selectedStock] = (wallet.stocks[selectedStock] || 0) + (amount / stock.price);
            alert(`ƒê√£ MUA th√†nh c√¥ng!`);
        } else {
            const currentVal = (wallet.stocks[selectedStock] || 0) * stock.price;
            if (amount > currentVal) return alert("Kh√¥ng ƒë·ªß c·ªï phi·∫øu ƒë·ªÉ b√°n!");
            wallet.stocks[selectedStock] -= (amount / stock.price);
            wallet.cash += amount;
            alert(`ƒê√£ B√ÅN th√†nh c√¥ng!`);
        }
        
        // L∆∞u v√† ƒë·ªìng b·ªô
        localStorage.setItem(`user_db_${currentUser}`, JSON.stringify(wallet));
        syncRankToServer();
        
        // Hi·ªáu ·ª©ng n√∫t b·∫•m
        const btn = document.activeElement;
        btn.style.transform = "scale(0.9)"; setTimeout(()=>btn.style.transform="scale(1)", 150);
    }

    // --- CHART ENGINE ---
    let ctx;
    function initChart() {
        const cvs = document.getElementById("chart");
        // TƒÉng ƒë·ªô ph√¢n gi·∫£i cho m√†n h√¨nh Retina/Mobile
        cvs.width = cvs.parentElement.clientWidth * 2;
        cvs.height = cvs.parentElement.clientHeight * 2;
        ctx = cvs.getContext("2d");
        ctx.scale(2, 2);
    }

    function drawChart() {
        if (!selectedStock || !candlesCache[selectedStock]) return;
        const data = candlesCache[selectedStock];
        if (data.length === 0) return;

        const W = ctx.canvas.width / 2;
        const H = ctx.canvas.height / 2;
        ctx.clearRect(0, 0, W, H);

        // T√¨m min/max ƒë·ªÉ v·∫Ω scale
        let min = Infinity, max = -Infinity;
        data.forEach(d => {
            if (d.low < min) min = d.low;
            if (d.high > max) max = d.high;
        });
        const range = max - min || 1;
        const paddingY = 30; 
        
        const getY = (val) => H - paddingY - ((val - min) / range) * (H - paddingY * 2);

        // V·∫Ω Grid Line
        ctx.strokeStyle = "#222";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 4; i++) {
            let y = H - paddingY - (i/4)*(H - paddingY*2);
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
        }

        // V·∫Ω N·∫øn
        const candleWidth = (W - 20) / 50; 
        data.forEach((d, i) => {
            const x = i * candleWidth + 10;
            const color = d.close >= d.open ? "#00ff88" : "#ff3b3b";
            
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            
            // V·∫Ω r√¢u n·∫øn (High - Low)
            ctx.beginPath();
            ctx.moveTo(x + candleWidth/2, getY(d.high));
            ctx.lineTo(x + candleWidth/2, getY(d.low));
            ctx.stroke();
            
            // V·∫Ω th√¢n n·∫øn (Open - Close)
            const yOpen = getY(d.open);
            const yClose = getY(d.close);
            const height = Math.abs(yOpen - yClose) || 1;
            ctx.fillRect(x + 1, Math.min(yOpen, yClose), candleWidth - 2, height);
        });
        
        // V·∫Ω ƒë∆∞·ªùng gi√° hi·ªán t·∫°i
        const lastY = getY(data[data.length-1].close);
        ctx.strokeStyle = "rgba(255, 255, 255, 0.5)";
        ctx.setLineDash([5, 5]);
        ctx.beginPath(); ctx.moveTo(0, lastY); ctx.lineTo(W, lastY); ctx.stroke();
        ctx.setLineDash([]);
    }

    // --- TIN T·ª®C ---
    async function loadNewsData() {
        try {
            const res = await fetch(NEWS_JSON_URL);
            const data = await res.json();
            newsList = data;
            renderNewsList();
        } catch(e) {}
    }

    function renderNewsList() {
        const container = document.getElementById("news-list-container");
        container.innerHTML = newsList.map(n => `
            <div class="news-card" style="border-left-color:${n.b > 0 ? 'var(--green)' : n.b < 0 ? 'var(--red)' : '#666'}">
                <div style="font-size:10px; color:#888; font-weight:bold; margin-bottom:5px;">
                    ${n.b > 0 ? 'T√çCH C·ª∞C' : n.b < 0 ? 'TI√äU C·ª∞C' : 'TH√îNG TIN'}
                </div>
                <div style="color:#ddd; line-height:1.4;">${n.t}</div>
            </div>
        `).join('');
    }

    function updateMiniTicker() {
        if (newsList.length === 0) return;
        const item = newsList[Math.floor(Math.random() * newsList.length)];
        const ticker = document.getElementById("mini-news-ticker");
        ticker.innerText = `üì∞ TIN M·ªöI: ${item.t}`;
        ticker.style.borderLeftColor = item.b > 0 ? "var(--green)" : item.b < 0 ? "var(--red)" : "#888";
    }

    // --- H√ÄM TI·ªÜN √çCH ---
    function logout() {
        if (confirm("ƒêƒÉng xu·∫•t kh·ªèi thi·∫øt b·ªã n√†y?")) {
            localStorage.removeItem("current_session");
            location.reload();
        }
    }

    function openSettings() { document.getElementById("settings-modal").style.display = 'flex'; }
    function toggleAudio() { 
        if(document.getElementById("toggle-bgm").checked) bgm.play(); else bgm.pause(); 
    }

    function switchTab(tabName) {
        document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        event.currentTarget.classList.add('active');
        
        if (tabName === 'rank') fetchLeaderboard();
        if (tabName === 'news') loadNewsData();
    }
</script>
</body>
</html>
