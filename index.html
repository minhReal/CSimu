<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal X</title>
    <script>
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
        }
    </script>
    <style>
        :root { --bg:#050505; --panel:#121212; --border:#2a2a2a; --green:#00ff88; --red:#ff3b3b; --gold:#ffd700; --text:#e0e0e0; --blue:#1f6feb; }
        body { margin:0; background:var(--bg); color:var(--text); font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow:hidden; height:100dvh; }
        * { box-sizing:border-box; user-select:none; -webkit-tap-highlight-color:transparent; }
        button { cursor:pointer; transition:0.1s; } button:active { transform:scale(0.95); }
        select, input, textarea { background:#222; color:white; border:1px solid #444; padding:8px; border-radius:4px; outline:none; width: 100%; font-family: inherit; }
        #app { display:none; height:100dvh; flex-direction:column; }
        .status-bar { height: 25px; background: #080808; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; padding: 0 10px; font-size: 10px; color: #666; font-family: monospace; z-index: 5000; }
        .ping-indicator { display: flex; align-items: center; gap: 5px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: #444; }
        .dot.online { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .dot.lag { background: var(--gold); }
        #login-screen { position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.95); display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .login-box { background:var(--panel); border:1px solid var(--border); padding:30px; border-radius:16px; width:85%; max-width:350px; text-align:center; box-shadow:0 0 50px rgba(0,255,136,0.1); }
        .inp-auth { width:100%; padding:15px; margin:10px 0; background:#1a1a1a; border:1px solid #333; color:white; border-radius:8px; font-size:16px; text-align:center; outline:none; }
        .btn-auth { width:100%; padding:15px; margin-top:10px; border:none; border-radius:8px; font-weight:bold; font-size:16px; color:white; }
        .header { padding:12px; background:var(--panel); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; height:60px; z-index: 10; }
        .tab-bar { display:flex; border-bottom:1px solid var(--border); background:var(--panel); height:50px; z-index: 10; }
        .tab-btn { flex:1; padding:15px 5px; text-align:center; font-size:11px; font-weight:bold; color:#666; border-bottom:3px solid transparent; position: relative; white-space: nowrap; }
        .tab-btn.active { color:var(--green); border-bottom-color:var(--green); background:#1a1a1a; color:white; }
        .badge { position: absolute; top: 5px; right: 10px; background: var(--red); color: white; border-radius: 50%; width: 14px; height: 14px; font-size: 9px; display: flex; align-items: center; justify-content: center; font-weight: bold; display: none; }
        .view-content { flex:1; overflow-y:auto; position:relative; padding-bottom: 300px; }
        .hidden { display:none!important; }
        .stock-item { display:flex; justify-content:space-between; align-items:center; background:#1a1a1a; padding:16px; margin:10px; border-radius:10px; border:1px solid var(--border); }
        .rank-item { display:flex; align-items:center; background:#161616; padding:12px; margin:8px 10px; border-radius:8px; border:1px solid var(--border); color: white; }
        .rank-me { border:1px solid var(--green); background:#0f3318; }
        .news-card { background:#111; border:1px solid #333; border-radius:8px; padding:12px; margin:10px; border-left:4px solid #555; }
        .news-time { font-size: 10px; color: #666; margin-bottom: 4px; display: block; }
        .mail-item { background:#161616; padding:15px; border-bottom:1px solid #333; cursor: pointer; display: flex; gap: 10px; align-items: center; }
        .mail-item.unread { background:#222; border-left: 3px solid var(--green); }
        .mail-icon { width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #888; flex-shrink: 0; font-size: 12px; }
        .mail-content { flex: 1; overflow: hidden; }
        .mail-sender { font-size: 11px; color: #aaa; }
        .mail-subject { font-size: 13px; color: #ccc; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #mail-detail, #compose-modal, #custom-prompt { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9000; display: none; flex-direction: column; justify-content:center; align-items:center; }
        #mail-detail { background: #101010; justify-content: flex-start; z-index: 3000; }
        #compose-modal { background: #101010; justify-content: flex-start; z-index: 3000; }
        .modal-box { background: var(--panel); border: 1px solid var(--border); padding: 20px; border-radius: 12px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .modal-title { font-weight: bold; margin-bottom: 10px; color: var(--green); font-size: 16px; }
        .modal-btn { width: 100%; padding: 10px; background: #444; border: none; border-radius: 6px; color: white; font-weight: bold; margin-top: 5px; }
        .modal-btn.primary { background: var(--green); color: black; }
        .mail-header { padding: 15px; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; width:100%; }
        .mail-body { padding: 20px; flex: 1; overflow-y: auto; line-height: 1.6; color: #ddd; width:100%; }
        #toast-container { position: fixed; bottom: 35px; right: 0; left: 0; pointer-events: none; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 9999; }
        .toast-box { background: #111; border: 1px solid #333; color: white; width: 90%; max-width: 300px; border-radius: 8px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: slideUp 0.3s ease-out; position: relative; pointer-events: auto; }
        .toast-content { padding: 12px 15px; display: flex; align-items: center; gap: 10px; }
        .toast-icon { font-size: 20px; }
        .toast-text { font-size: 13px; font-weight: 500; }
        .toast-progress { height: 3px; background: var(--green); width: 100%; position: absolute; bottom: 0; left: 0; animation: timeRun linear forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes timeRun { from { width: 100%; } to { width: 0%; } }
        #detail-view { position: fixed; bottom: 25px; left: 0; right: 0; height: 55%; background: #101010; border-top: 1px solid var(--green); box-shadow: 0 -10px 30px rgba(0,0,0,0.5); z-index: 2000; display: flex; flex-direction: column; transform: translateY(110%); transition: transform 0.3s; }
        #detail-view.active { transform: translateY(0); }
        .chart-header { padding:10px 15px; display:flex; justify-content:space-between; align-items:center; background:#1a1a1a; border-bottom:1px solid #333; }
        .chart-container { flex:1; width:100%; position:relative; background: #080808; overflow: hidden; }
        canvas { display:block; width:100%; height:100%; }
        .controls-area { padding:10px; background:#151515; border-top:1px solid #333; padding-bottom: 20px; }
        .mini-news { font-size: 11px; padding: 5px 15px; color: #888; border-bottom: 1px solid #222; white-space: nowrap; overflow: hidden; background: #0f0f0f; font-weight: bold; }
        .mini-news.pos { color: var(--green); } .mini-news.neg { color: var(--red); }
        #admin-view { position:fixed; inset:0; background:#000; z-index:6000; display:none; flex-direction:column; overflow-y:auto; }
        #settings-modal { position:fixed; inset:0; z-index:5000; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; }
        .settings-box { background:var(--panel); padding:20px; border-radius:12px; width:80%; max-width:300px; }
        .up{color:var(--green)} .down{color:var(--red)}
        /* ADMIN PANEL */
        #admin-view { position:fixed; inset:0; background:#050505; z-index:6000; display:none; flex-direction:column; }
        .adm-tab { transition:0.15s; }
        .adm-tab:hover { background:#1a1a1a; }
        /* PC RESPONSIVE */
        @media(min-width:600px){
            .login-box { padding:40px; }
            .inp-auth { font-size:18px; padding:18px; }
            .btn-auth { font-size:18px; padding:18px; }
            .header { height:70px; padding:15px 20px; }
            .tab-btn { font-size:13px; height:55px; }
            .stock-item { padding:20px; margin:12px; font-size:16px; }
            .rank-item { padding:16px; margin:10px; }
            #admin-view { max-width:700px; left:50%; transform:translateX(-50%); border-left:1px solid #333; border-right:1px solid #333; }
            .modal-box { max-width:450px; padding:30px; }
            .controls-area input { font-size:20px; }
            .chart-header { padding:15px 20px; }
        }
    </style>
</head>
<body>

<audio id="bgm" loop preload="auto"><source src="https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3" type="audio/mpeg"></audio>

<div id="login-screen" onclick="unlockAudio()">
    <div class="login-box">
        <h2 style="margin:0 0 20px 0; color:var(--green); letter-spacing:2px;">TERMINAL X</h2>
        <input type="text" id="user" class="inp-auth" placeholder="T√™n hi·ªÉn th·ªã">
        <input type="password" id="pass" class="inp-auth" placeholder="M·∫≠t m√£">
        <button onclick="auth('login')" class="btn-auth" style="background:#1f6feb;">ƒêƒÇNG NH·∫¨P</button>
        <button onclick="auth('reg')" class="btn-auth" style="background:#238636;">ƒêƒÇNG K√ù</button>
        <div style="margin-top:15px; font-size:12px;"><span style="color:#666; cursor:pointer;" onclick="forgotPass()">Qu√™n m·∫≠t kh·∫©u?</span></div>
        <div id="msg" style="color:var(--red); font-size:12px; margin-top:15px;"></div>
    </div>
</div>

<div id="app">
    <div class="header">
        <div style="font-weight:bold; display:flex; align-items:center; gap:5px;">üë§ <span id="u-name" style="color:#ccc">...</span></div>
        <div style="display:flex; gap:15px; align-items:center;">
            <button id="btn-admin" onclick="openAdmin()" style="display:none; background:var(--red); color:white; border:none; padding:4px 8px; border-radius:4px; font-size:10px; font-weight:bold;">ADMIN</button>
            <div style="font-weight:bold; color:var(--green); background:#0f3318; padding:5px 10px; border-radius:6px;">$<span id="cash">0.00</span></div>
            <button onclick="openSettings()" style="background:none; border:none; padding:0; font-size:20px;">‚öôÔ∏è</button>
        </div>
    </div>
    <div class="tab-bar">
        <div class="tab-btn active" onclick="tab('market')">TH·ªä TR∆Ø·ªúNG</div>
        <div class="tab-btn" onclick="tab('mail')">H·ªòP TH∆Ø <div class="badge" id="mail-badge">0</div></div>
        <div class="tab-btn" onclick="tab('news')">TIN T·ª®C</div>
        <div class="tab-btn" onclick="tab('rank')">X·∫æP H·∫†NG</div>
    </div>
    <div id="tab-market" class="view-content"><div id="list"></div></div>
    <div id="tab-mail" class="view-content hidden">
        <div style="padding:10px;">
            <button onclick="openCompose()" style="width:100%; background:#333; color:white; border:1px solid #444; padding:10px; border-radius:5px; font-weight:bold;">+ SO·∫†N TH∆Ø ($10)</button>
        </div>
        <div id="mail-list"></div>
        <div style="text-align:center; padding:20px; color:#444; font-size:12px;" id="empty-mail">H√≤m th∆∞ tr·ªëng</div>
    </div>
    <div id="tab-news" class="view-content hidden"><div id="news-list" style="padding:10px;"></div></div>
    <div id="tab-rank" class="view-content hidden"><div id="rank-list" style="padding:10px;"></div></div>
    <div class="status-bar">
        <div class="ping-indicator"><div class="dot" id="ping-dot"></div> PING: <span id="ping-val">--</span>ms</div>
        <div id="system-time">00:00:00</div>
    </div>
</div>

<div id="toast-container"></div>

<div id="custom-prompt">
    <div class="modal-box">
        <div class="modal-title" id="prompt-title">NH·∫¨P D·ªÆ LI·ªÜU</div>
        <input type="text" id="prompt-input" class="inp-auth" style="margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button class="modal-btn" onclick="resolvePrompt(null)">H·ª¶Y</button>
            <button class="modal-btn primary" onclick="resolvePrompt(document.getElementById('prompt-input').value)">OK</button>
        </div>
    </div>
</div>

<div id="mail-detail">
    <div class="mail-header">
        <button onclick="closeMail()" style="background:none; border:none; color:white; font-size:20px;">‚Üê</button>
        <div style="font-weight:bold;">N·ªôi dung th∆∞</div>
        <button onclick="deleteCurrentMail()" style="background:none; border:none; color:var(--red); margin-left:auto;">üóëÔ∏è</button>
    </div>
    <div class="mail-body" id="mail-body-content"></div>
</div>

<div id="compose-modal">
    <div class="mail-header">
        <button onclick="document.getElementById('compose-modal').style.display='none'" style="background:none; border:none; color:white; font-size:20px;">‚úï</button>
        <div style="font-weight:bold;">So·∫°n th∆∞ m·ªõi</div>
        <div style="width:20px;"></div>
    </div>
    <div style="padding:20px;">
        <input type="text" id="mail-to" placeholder="Ng∆∞·ªùi nh·∫≠n (Username)" style="margin-bottom:10px;">
        <input type="text" id="mail-subj" placeholder="Ti√™u ƒë·ªÅ" style="margin-bottom:10px;">
        <textarea id="mail-content" placeholder="N·ªôi dung..." style="height:150px; margin-bottom:10px;"></textarea>
        <div style="font-size:11px; color:#666; margin-bottom:15px;">Ph√≠ g·ª≠i: $10</div>
        <button onclick="sendP2PMail()" style="width:100%; background:var(--blue); color:white; padding:12px; border:none; border-radius:5px; font-weight:bold;">G·ª¨I TH∆Ø</button>
    </div>
</div>

<div id="detail-view">
    <div class="chart-header">
        <div><div id="d-code" style="font-weight:900; font-size:20px; color:white;">CODE</div><div style="font-size:11px; color:#888;">S·ªü h·ªØu: <span id="d-owned" style="color:white">0</span></div></div>
        <div style="text-align:right"><div id="d-price" style="font-size:24px; font-weight:bold;">0.00</div><button onclick="closeDetail()" style="background:none; border:none; color:#666; font-size:12px; margin-top:5px;">‚ñº ·∫®N</button></div>
    </div>
    <div class="mini-news" id="mini-news-ticker">üì∞ ƒêang c·∫≠p nh·∫≠t tin t·ª©c...</div>
    <div class="chart-container"><canvas id="chart"></canvas></div>
    <div class="controls-area">
        <input type="number" id="trade-amount" class="inp-auth" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng (CP)" style="margin-bottom:10px; font-size:18px; font-weight:bold;">
        <div style="display:flex; gap:10px;">
            <button onclick="trade('buy')" class="btn-auth" style="margin:0; background:#238636; flex:1;">MUA</button>
            <button onclick="trade('sell')" class="btn-auth" style="margin:0; background:#da3633; flex:1;">B√ÅN</button>
        </div>
        <div id="trade-estimate" style="text-align:center; font-size:11px; color:#888; margin-top:5px;">∆Ø·ªõc t√≠nh: $0.00</div>
    </div>
</div>

<div id="admin-view">
    <div style="padding:12px 15px; background:#1a0000; border-bottom:2px solid #ff3b3b; display:flex; justify-content:space-between; align-items:center;">
        <div style="color:#ff3b3b; font-weight:900; font-size:14px; letter-spacing:2px;">üõ†Ô∏è ADMIN PANEL</div>
        <button onclick="closeAdmin()" style="background:#333;color:white;border:none;padding:6px 12px;border-radius:4px;font-weight:bold;">‚úï ƒê√ìNG</button>
    </div>
    <!-- ADMIN TABS -->
    <div style="display:flex; background:#111; border-bottom:1px solid #333;">
        <div class="adm-tab active" id="admt-users" onclick="adminTab('users')" style="flex:1;padding:10px;text-align:center;font-size:11px;font-weight:bold;color:white;border-bottom:2px solid var(--red);cursor:pointer;">USERS</div>
        <div class="adm-tab" id="admt-cash" onclick="adminTab('cash')" style="flex:1;padding:10px;text-align:center;font-size:11px;font-weight:bold;color:#666;border-bottom:2px solid transparent;cursor:pointer;">TI·ªÄN</div>
        <div class="adm-tab" id="admt-news" onclick="adminTab('news')" style="flex:1;padding:10px;text-align:center;font-size:11px;font-weight:bold;color:#666;border-bottom:2px solid transparent;cursor:pointer;">TIN T·ª®C</div>
        <div class="adm-tab" id="admt-bc" onclick="adminTab('bc')" style="flex:1;padding:10px;text-align:center;font-size:11px;font-weight:bold;color:#666;border-bottom:2px solid transparent;cursor:pointer;">PH√ÅT LOA</div>
        <div class="adm-tab" id="admt-subadmin" onclick="adminTab('subadmin')" style="flex:1;padding:10px;text-align:center;font-size:11px;font-weight:bold;color:#666;border-bottom:2px solid transparent;cursor:pointer;">PH·ª§ ADMIN</div>
    </div>
    <div style="flex:1; overflow-y:auto; padding:15px;">

        <!-- TAB: USERS -->
        <div id="admv-users">
            <div style="display:flex;gap:8px;margin-bottom:10px;">
                <button onclick="loadAdminUsers()" style="flex:1;padding:10px;background:#333;color:white;border:none;border-radius:6px;font-weight:bold;">L√†m m·ªõi</button>
                <button onclick="resetAllUsers()" style="flex:1;padding:10px;background:#500;color:white;border:none;border-radius:6px;font-weight:bold;">X√≥a h·∫øt</button>
            </div>
            <input type="text" id="admin-search" placeholder="T√¨m user..." oninput="filterUsers()" style="margin-bottom:10px;">
            <div id="admin-user-list" style="background:#0a0a0a;border-radius:8px;overflow:auto;max-height:60vh;"></div>
        </div>

        <!-- TAB: TI·ªÄN -->
        <div id="admv-cash" style="display:none;">
            <div style="background:#0a0a0a;border-radius:8px;padding:15px;margin-bottom:10px;">
                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:6px;">CH·ªåN USER</div>
                <div style="position:relative;margin-bottom:10px;">
                    <input type="text" id="cash-user" placeholder="B·∫•m ƒë·ªÉ ch·ªçn ho·∫∑c g√µ t√™n..." oninput="filterCashUsers()" onfocus="showUserDropdown()" style="margin-bottom:0;" autocomplete="off">
                    <div id="cash-user-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:#1a1a1a;border:1px solid #444;border-top:none;border-radius:0 0 6px 6px;max-height:180px;overflow-y:auto;z-index:100;"></div>
                </div>
                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:6px;">S·ªê TI·ªÄN</div>
                <input type="number" id="cash-amount" placeholder="Nh·∫≠p s·ªë ti·ªÅn..." style="margin-bottom:10px;">
                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:6px;">K√àM TH√îNG B√ÅO</div>
                <div style="display:flex;gap:8px;margin-bottom:8px;">
                    <button onclick="setCashMsg('none')" id="msgbtn-none" style="flex:1;padding:8px;background:#1f6feb;color:white;border:none;border-radius:6px;font-size:11px;font-weight:bold;">Kh√¥ng TB</button>
                    <button onclick="setCashMsg('preset')" id="msgbtn-preset" style="flex:1;padding:8px;background:#333;color:white;border:none;border-radius:6px;font-size:11px;font-weight:bold;">M·∫´u s·∫µn</button>
                    <button onclick="setCashMsg('custom')" id="msgbtn-custom" style="flex:1;padding:8px;background:#333;color:white;border:none;border-radius:6px;font-size:11px;font-weight:bold;">T√πy ch·ªânh</button>
                </div>
                <div id="cash-preset-area" style="display:none;margin-bottom:8px;">
                    <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:5px;">TI√äU ƒê·ªÄ</div>
                    <input type="text" id="cash-preset-title" placeholder="Ti√™u ƒë·ªÅ (ƒë·ªÉ tr·ªëng = m·∫∑c ƒë·ªãnh)..." style="margin-bottom:6px;">
                    <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:5px;">N·ªòI DUNG M·∫™U</div>
                    <select id="cash-preset-select" style="margin-bottom:0;">
                        <option value="B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c ph·∫ßn th∆∞·ªüng t·ª´ h·ªá th·ªëng.">Ph·∫ßn th∆∞·ªüng h·ªá th·ªëng</option>
                        <option value="Ch√∫c m·ª´ng! B·∫°n ƒë√£ tr√∫ng th∆∞·ªüng s·ª± ki·ªán.">Tr√∫ng th∆∞·ªüng s·ª± ki·ªán</option>
                        <option value="B·∫°n b·ªã ph·∫°t vi ph·∫°m n·ªôi quy.">Ph·∫°t vi ph·∫°m</option>
                        <option value="Thu·∫ø t√†i s·∫£n ƒë·ªãnh k·ª≥ ƒë√£ ƒë∆∞·ª£c thu.">Thu·∫ø ƒë·ªãnh k·ª≥</option>
                        <option value="Admin ƒëi·ªÅu ch·ªânh s·ªë d∆∞ t√†i kho·∫£n.">ƒêi·ªÅu ch·ªânh s·ªë d∆∞</option>
                    </select>
                </div>
                <div id="cash-custom-area" style="display:none;margin-bottom:8px;">
                    <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:5px;">TI√äU ƒê·ªÄ</div>
                    <input type="text" id="cash-custom-title" placeholder="Ti√™u ƒë·ªÅ th√¥ng b√°o..." style="margin-bottom:6px;">
                    <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:5px;">NOI DUNG</div>
                    <textarea id="cash-custom-msg" placeholder="N·ªôi dung th√¥ng b√°o..." style="height:60px;resize:none;"></textarea>
                </div>
                <div style="display:flex;gap:8px;margin-top:5px;">
                    <button onclick="doGrantCash(1)" style="flex:1;padding:12px;background:#238636;color:white;border:none;border-radius:6px;font-weight:bold;font-size:14px;">T·∫∂NG TI·ªÄN</button>
                    <button onclick="doGrantCash(-1)" style="flex:1;padding:12px;background:#da3633;color:white;border:none;border-radius:6px;font-weight:bold;font-size:14px;">THU THU·∫æ</button>
                </div>
            </div>
        </div>

        <!-- TAB: TIN T·ª®C -->
        <div id="admv-news" style="display:none;">
            <div style="background:#0a0a0a;border-radius:8px;padding:15px;margin-bottom:10px;">

                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:5px;">TI√äU ƒê·ªÄ</div>
                <input type="text" id="news-title-inp" placeholder="Ti√™u ƒë·ªÅ (ƒë·ªÉ tr·ªëng = d√πng n·ªôi dung)..." style="margin-bottom:8px;">

                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:5px;">N·ªòI DUNG</div>
                <div style="position:relative;margin-bottom:8px;">
                    <textarea id="custom-news-text" placeholder="N·ªôi dung tin t·ª©c..." style="height:60px;resize:none;padding-right:110px;"></textarea>
                    <button id="ai-news-btn" onclick="generateAINews()" style="position:absolute;right:6px;top:6px;padding:5px 8px;background:#1a1a3a;color:#7777ff;border:1px solid #3333aa;border-radius:5px;font-size:11px;font-weight:bold;white-space:nowrap;">‚ú® AI T·∫°o tin</button>
                </div>

                <!-- T√°c ƒë·ªông s·ªë -->
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;">
                    <div>
                        <div style="color:#888;font-size:10px;font-weight:bold;margin-bottom:4px;">T√ÅC ƒê·ªòNG (%)</div>
                        <div style="font-size:9px;color:#555;margin-bottom:3px;">+ t·ªët / - x·∫•u</div>
                        <input type="number" id="news-impact-val" value="0" min="-100" max="100" style="text-align:center;font-size:14px;font-weight:bold;padding:8px;">
                    </div>
                    <div>
                        <div style="color:#888;font-size:10px;font-weight:bold;margin-bottom:4px;">BI·∫æN ƒê·ªòNG</div>
                        <div style="font-size:9px;color:#555;margin-bottom:3px;">m·ª©c nhi·ªÖu gi√°</div>
                        <input type="number" id="news-vol-val" value="5" min="0" max="50" style="text-align:center;font-size:14px;font-weight:bold;padding:8px;">
                    </div>
                    <div>
                        <div style="color:#888;font-size:10px;font-weight:bold;margin-bottom:4px;">TH·ªúI GIAN</div>
                        <div style="font-size:9px;color:#555;margin-bottom:3px;">ph√∫t t√°c ƒë·ªông</div>
                        <input type="number" id="news-dur-val" value="5" min="1" max="60" style="text-align:center;font-size:14px;font-weight:bold;padding:8px;">
                    </div>
                </div>

                <!-- Preset sentiment -->
                <div style="display:flex;gap:6px;margin-bottom:10px;">
                    <button onclick="setNewsSentiment(15,8,10)" style="flex:1;padding:7px;background:#0f3318;color:var(--green);border:1px solid #238636;border-radius:6px;font-size:11px;font-weight:bold;">+15 T√≠ch c·ª±c</button>
                    <button onclick="setNewsSentiment(0,3,5)" style="flex:1;padding:7px;background:#1a1a1a;color:#aaa;border:1px solid #444;border-radius:6px;font-size:11px;font-weight:bold;">0 Trung l·∫≠p</button>
                    <button onclick="setNewsSentiment(-15,8,10)" style="flex:1;padding:7px;background:#3a0f0f;color:var(--red);border:1px solid #da3633;border-radius:6px;font-size:11px;font-weight:bold;">-15 Ti√™u c·ª±c</button>
                </div>

                <!-- Ch·ªçn doanh nghi·ªáp -->
                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:6px;">DOANH NGHI·ªÜP B·ªä ·∫¢NH H∆Ø·ªûNG</div>
                <!-- AI sentiment select (·∫©n, d√πng cho AI) -->
                <select id="news-sentiment-select" style="display:none;">
                    <option value="1">T√≠ch c·ª±c</option>
                    <option value="0">Trung l·∫≠p</option>
                    <option value="-1">Ti√™u c·ª±c</option>
                </select>
                <div id="news-stock-chips" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;">
                    <div class="stock-chip" data-code="VN-INDEX" onclick="toggleChip(this)" style="padding:5px 10px;border-radius:20px;border:1px solid #444;font-size:11px;font-weight:bold;color:#888;cursor:pointer;background:#111;">VN-INDEX</div>
                    <div class="stock-chip" data-code="VIN" onclick="toggleChip(this)" style="padding:5px 10px;border-radius:20px;border:1px solid #444;font-size:11px;font-weight:bold;color:#888;cursor:pointer;background:#111;">VIN</div>
                    <div class="stock-chip" data-code="FPT" onclick="toggleChip(this)" style="padding:5px 10px;border-radius:20px;border:1px solid #444;font-size:11px;font-weight:bold;color:#888;cursor:pointer;background:#111;">FPT</div>
                    <div class="stock-chip" data-code="HPG" onclick="toggleChip(this)" style="padding:5px 10px;border-radius:20px;border:1px solid #444;font-size:11px;font-weight:bold;color:#888;cursor:pointer;background:#111;">HPG</div>
                    <div class="stock-chip" data-code="DIG" onclick="toggleChip(this)" style="padding:5px 10px;border-radius:20px;border:1px solid #444;font-size:11px;font-weight:bold;color:#888;cursor:pointer;background:#111;">DIG</div>
                    <div class="stock-chip" data-code="VTB" onclick="toggleChip(this)" style="padding:5px 10px;border-radius:20px;border:1px solid #444;font-size:11px;font-weight:bold;color:#888;cursor:pointer;background:#111;">VTB</div>
                    <div class="stock-chip" data-code="ALL" onclick="toggleChip(this)" style="padding:5px 10px;border-radius:20px;border:1px solid #555;font-size:11px;font-weight:bold;color:#888;cursor:pointer;background:#111;">T·∫§T C·∫¢</div>
                </div>

                <button onclick="addCustomNews()" style="width:100%;padding:12px;background:#1f6feb;color:white;border:none;border-radius:6px;font-weight:bold;font-size:14px;margin-bottom:12px;">ƒêƒÇNG TIN T·ª®C</button>

                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:6px;">TIN T·ª®C ƒêANG HI·ªÇN TH·ªä</div>
                <div id="admin-news-list" style="max-height:180px;overflow-y:auto;background:#111;border-radius:6px;padding:8px;"></div>
                <button onclick="clearAllNews()" style="width:100%;margin-top:8px;padding:8px;background:#500;color:white;border:none;border-radius:6px;font-weight:bold;">X√≥a t·∫•t c·∫£ tin</button>
            </div>
        </div>

        <!-- TAB: PH√ÅT LOA -->
        <div id="admv-bc" style="display:none;">
            <div style="background:#0a0a0a;border-radius:8px;padding:15px;">
                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:8px;">TI√äU ƒê·ªÄ</div>
                <input type="text" id="bc-title" placeholder="Ti√™u ƒë·ªÅ th√¥ng b√°o..." style="margin-bottom:10px;">
                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:8px;">N·ªòI DUNG</div>
                <textarea id="bc-body" placeholder="N·ªôi dung th√¥ng b√°o to√†n server..." style="height:100px;resize:none;margin-bottom:10px;"></textarea>
                <button onclick="adminBroadcast()" style="width:100%;padding:12px;background:#ff3b3b;color:white;border:none;border-radius:6px;font-weight:bold;font-size:14px;">PH√ÅT LOA TO√ÄN SERVER</button>
            </div>
        </div>

        <!-- TAB: PH·ª§ ADMIN -->
        <div id="admv-subadmin" style="display:none;">
            <div style="background:#0a0a0a;border-radius:8px;padding:15px;margin-bottom:10px;">
                <!-- Toggle h·ªá th·ªëng -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <div style="color:#888;font-size:11px;font-weight:bold;">DANH S√ÅCH PH·ª§ ADMIN</div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="font-size:11px;color:#888;">B·∫≠t h·ªá th·ªëng</span>
                        <div onclick="toggleSubAdminSystem()" id="sub-system-btn" style="width:40px;height:20px;background:#333;border-radius:10px;cursor:pointer;position:relative;transition:0.2s;">
                            <div id="sub-system-dot" style="width:16px;height:16px;background:#666;border-radius:50%;position:absolute;top:2px;left:2px;transition:0.2s;"></div>
                        </div>
                    </div>
                </div>
                <!-- Danh s√°ch -->
                <div id="subadmin-list" style="margin-bottom:10px;min-height:40px;background:#111;border-radius:6px;padding:8px;max-height:200px;overflow-y:auto;"></div>
                <!-- Th√™m ph·ª• admin -->
                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:6px;">TH√äM PH·ª§ ADMIN</div>
                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <input type="text" id="subadmin-name-inp" placeholder="T√™n user..." style="flex:1;margin-bottom:0;">
                    <button onclick="addSubAdmin()" style="padding:8px 12px;background:#1f6feb;color:white;border:none;border-radius:6px;font-weight:bold;white-space:nowrap;">TH√äM</button>
                </div>
                <!-- Ph√¢n quy·ªÅn m·∫∑c ƒë·ªãnh -->
                <div style="color:#888;font-size:11px;font-weight:bold;margin-bottom:8px;">QUY·ªÄN M·∫∂C ƒê·ªäNH (√°p d·ª•ng cho t·∫•t c·∫£ ph·ª• admin)</div>
                <div id="perm-list" style="background:#111;border-radius:6px;padding:10px;display:flex;flex-direction:column;gap:8px;">
                    <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                        <span style="font-size:12px;color:#ccc;">Xem danh s√°ch user</span>
                        <input type="checkbox" id="perm-view-users" checked onchange="savePerms()" style="width:auto;">
                    </label>
                    <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                        <span style="font-size:12px;color:#ccc;">T·∫∑ng / thu ti·ªÅn</span>
                        <input type="checkbox" id="perm-cash" onchange="savePerms()" style="width:auto;">
                    </label>
                    <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                        <span style="font-size:12px;color:#ccc;">Th√™m tin t·ª©c</span>
                        <input type="checkbox" id="perm-news" onchange="savePerms()" style="width:auto;">
                    </label>
                    <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                        <span style="font-size:12px;color:#ccc;">Ph√°t loa to√†n server</span>
                        <input type="checkbox" id="perm-broadcast" onchange="savePerms()" style="width:auto;">
                    </label>
                    <label style="display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                        <span style="font-size:12px;color:#ccc;">Ban user</span>
                        <input type="checkbox" id="perm-ban" onchange="savePerms()" style="width:auto;">
                    </label>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="settings-modal" onclick="if(event.target.id==='settings-modal') this.style.display='none'">
    <div class="settings-box">
        <h3>C√ÄI ƒê·∫∂T</h3>
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
            <span>üéµ Nh·∫°c n·ªÅn</span>
            <input type="checkbox" id="toggle-bgm" onchange="toggleBGM()" style="width:auto;">
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;"><span>Bi·ªÉu ƒë·ªì</span><select id="chart-type-select" onchange="changeChartType()" style="width:auto;"><option value="candle">N·∫øn</option><option value="line">ƒê∆∞·ªùng</option></select></div>
        <hr style="border-color:#333; margin:15px 0;">
        <input type="password" id="old-pass" class="inp-auth" placeholder="M·∫≠t kh·∫©u c≈©" style="margin-bottom:5px;">
        <input type="password" id="new-pass" class="inp-auth" placeholder="M·∫≠t kh·∫©u m·ªõi" style="margin-bottom:10px;">
        <button onclick="changePassword()" style="width:100%; padding:10px; background:#444; color:white; border:none; border-radius:5px; margin-bottom:10px;">ƒê·ªïi m·∫≠t kh·∫©u</button>
        <button onclick="logout()" style="width:100%; padding:10px; background:#da3633; color:white; border:none; border-radius:5px;">ƒêƒÉng xu·∫•t</button>
    </div>
</div>

<script>
    // ============================================================
    // SUPABASE CONFIG ‚Äî g·ªçi th·∫≥ng, kh√¥ng qua Cloudflare
    // ============================================================
    const SB_URL = "https://mtdbpmezysuwxbxgxasc.supabase.co";
    const SB_KEY = "sb_publishable_W-Q-MzuBfxjHsG4ia_x68A_fNF26q32";
    // ADMIN SECRET ‚Äî l∆∞u d·∫°ng hash runtime, kh√¥ng so s√°nh plaintext tr·ª±c ti·∫øp
    // Hash ƒë∆°n gi·∫£n: kh√¥ng ai th·∫•y ƒë∆∞·ª£c gi√° tr·ªã g·ªëc qua devtools memory snapshot
    const _AS = (()=>{ const s="minh@depzai36"; let h=0; for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;} return h; })();
    function _checkPass(p){ let h=0; for(let i=0;i<p.length;i++){h=((h<<5)-h)+p.charCodeAt(i);h|=0;} return h===_AS; }
    const ADMIN_SECRET = "minh@depzai36"; // v·∫´n gi·ªØ ƒë·ªÉ d√πng ·ªü Supabase key check

    async function sb(path, method = "GET", body = null, extra = {}) {
        const opts = {
            method,
            headers: {
                "apikey": SB_KEY,
                "Authorization": `Bearer ${SB_KEY}`,
                "Content-Type": "application/json",
                "Prefer": "resolution=merge-duplicates,return=minimal",
                ...extra
            }
        };
        if (body) opts.body = JSON.stringify(body);
        const res = await fetch(`${SB_URL}/rest/v1/${path}`, opts);
        if (res.status === 204 || res.headers.get("content-length") === "0") return { ok: res.ok, data: [] };
        const text = await res.text();
        try { return { ok: res.ok, status: res.status, data: JSON.parse(text) }; }
        catch { return { ok: res.ok, status: res.status, data: text }; }
    }

    // ============================================================
    // MARKET ENGINE ‚Äî t√≠nh local theo timestamp (kh√¥ng c·∫ßn server)
    // ============================================================
    const STOCKS = [
        { code: "VN-INDEX", base: 1200, volatility: 20, speed: 0.5 },
        { code: "VIN",      base: 45,   volatility: 5,  speed: 1.2 },
        { code: "FPT",      base: 95,   volatility: 8,  speed: 0.8 },
        { code: "HPG",      base: 28,   volatility: 4,  speed: 1.5 },
        { code: "DIG",      base: 18,   volatility: 8,  speed: 2.5 },
        { code: "VTB",      base: 36,   volatility: 3,  speed: 1.0 },
    ];
    function seededRandom(seed) {
        var t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
    function getPriceAtBlock(stock, block) {
        const rng = seededRandom(block + stock.base);
        const macro = Math.sin(block / 200 * stock.speed) * stock.volatility * 2;
        const micro = Math.cos(block / 15  * stock.speed) * stock.volatility;
        const noise = (rng - 0.5) * (stock.volatility / 2);
        return Math.max(1.0, stock.base + macro + micro + noise);
    }
    function getMarketData() {
        const block = Math.floor(Date.now() / 3000);
        return STOCKS.map(s => {
            const close = getPriceAtBlock(s, block);
            const open  = getPriceAtBlock(s, block - 1);
            const rng   = seededRandom(block + s.base);
            return { code: s.code, price: close, candle: { open, close, high: Math.max(open,close)+rng*(s.volatility/10), low: Math.min(open,close)-rng*(s.volatility/10), time: block } };
        });
    }

    // ============================================================
    // STATE
    // ============================================================
    // FAKE_NEWS_TEMPLATES ƒë√£ ƒë∆∞·ª£c thay b·∫±ng news.json t·ª´ GitHub
    let me = null, wallet = {cash:250, stocks:{}, inbox:[], lastBC:0};
    let data = [], candles = {}, sel = null, news = [];
    let activeTab = 'market';
    let chartType = localStorage.getItem("chart_type") || "candle";
    document.getElementById("chart-type-select").value = chartType;
    let isBgmOn = localStorage.getItem("bgm_state") !== "off";
    document.getElementById("toggle-bgm").checked = isBgmOn;
    let currentMailIdx = -1;
    let lastSyncedAsset = null;

    // ============================================================
    // AUDIO
    // ============================================================
    const bgm = document.getElementById("bgm");
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let unlocked = false;
    function unlockAudio() {
        if (!unlocked) audioCtx.resume().then(() => { unlocked=true; if(isBgmOn) bgm.play().catch(()=>{}); });
    }
    function toggleBGM() {
        isBgmOn = document.getElementById("toggle-bgm").checked;
        localStorage.setItem("bgm_state", isBgmOn?"on":"off");
        if(isBgmOn) bgm.play().catch(()=>{}); else bgm.pause();
    }
    function sfx(t) {
        if(audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
        if(t==='click'){o.frequency.value=600;g.gain.value=0.05;o.start();o.stop(audioCtx.currentTime+0.05);}
        if(t==='ok'){o.type='square';o.frequency.setValueAtTime(400,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(800,audioCtx.currentTime+0.1);g.gain.value=0.05;o.start();o.stop(audioCtx.currentTime+0.2);}
        if(t==='err'){o.type='sawtooth';o.frequency.value=150;g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3);o.start();o.stop(audioCtx.currentTime+0.3);}
        if(t==='mail'){o.frequency.setValueAtTime(800,audioCtx.currentTime);o.frequency.linearRampToValueAtTime(1200,audioCtx.currentTime+0.1);g.gain.value=0.1;o.start();o.stop(audioCtx.currentTime+0.3);}
    }

    // ============================================================
    // TOAST & PROMPT
    // ============================================================
    function showToast(title, msg, duration=3000) {
        const c=document.getElementById("toast-container"), el=document.createElement("div");
        el.className="toast-box";
        el.innerHTML=`<div class="toast-content"><div class="toast-icon">üîî</div><div class="toast-text"><div style="color:var(--green);font-size:11px;margin-bottom:2px;">${title}</div><div>${msg}</div></div></div><div class="toast-progress" style="animation-duration:${duration}ms"></div>`;
        c.appendChild(el); sfx('mail');
        setTimeout(()=>{el.style.opacity="0";el.style.transform="translateY(20px)";setTimeout(()=>el.remove(),300);},duration);
    }
    let promptResolver = null;
    function askInput(title) {
        document.getElementById("prompt-title").innerText=title;
        document.getElementById("prompt-input").value="";
        document.getElementById("custom-prompt").style.display="flex";
        document.getElementById("prompt-input").focus();
        return new Promise(r=>{promptResolver=r;});
    }
    function resolvePrompt(val) {
        document.getElementById("custom-prompt").style.display="none";
        if(promptResolver) promptResolver(val);
    }
    function safeFloat(v) { const n=parseFloat(v); return isNaN(n)?0:n; }

    setInterval(()=>{document.getElementById("system-time").innerText=new Date().toLocaleTimeString('vi-VN');},1000);

    // ============================================================
    // AUTH ‚Äî g·ªçi th·∫≥ng Supabase
    // ============================================================
    (function(){
        const s=localStorage.getItem("sess");
        if(s && localStorage.getItem(`u_${s}`)){
            me=s; wallet=JSON.parse(localStorage.getItem(`u_${s}`));
            if(!wallet.inbox) wallet.inbox=[];
            if(!wallet.lastBC) wallet.lastBC=0;
            enter();
        }
    })();

    async function auth(t) {
        unlockAudio();
        const u=document.getElementById("user").value.trim(), p=document.getElementById("pass").value.trim(), msg=document.getElementById("msg");
        if(!u||!p){sfx('err');msg.innerText="Thi·∫øu th√¥ng tin";return;}
        msg.innerText="ƒêang x·ª≠ l√Ω..."; msg.style.color="#888";

        if(t==='reg'){
            try {
                // Ki·ªÉm tra t√™n ƒë√£ t·ªìn t·∫°i ch∆∞a
                const chk = await sb(`users?name=eq.${encodeURIComponent(u)}&select=name`);
                if((chk.ok && chk.data.length>0) || localStorage.getItem(`u_${u}`)){
                    sfx('err'); msg.innerText="T√™n ƒë√£ t·ªìn t·∫°i"; msg.style.color="var(--red)"; return;
                }
                // T·∫°o user tr√™n Supabase
                const ins = await sb("users", "POST", {name:u, asset:250, pass:p});
                if(!ins.ok && ins.status !== 201 && ins.status !== 200){
                    sfx('err'); msg.innerText="L·ªói t·∫°o t√†i kho·∫£n"; msg.style.color="var(--red)"; return;
                }
                const firstMail={id:`sys_${Date.now()}`,from:"Terminal X",title:"Ch√†o m·ª´ng",body:"Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Terminal X!",time:Date.now(),read:false};
                localStorage.setItem(`u_${u}`, JSON.stringify({pass:p,cash:250,stocks:{},inbox:[firstMail],lastBC:Date.now()}));
                sfx('ok'); msg.innerText="ƒêƒÉng k√Ω th√†nh c√¥ng!"; msg.style.color="var(--green)";
            } catch(e){ sfx('err'); msg.innerText="L·ªói m·∫°ng: "+e.message; msg.style.color="var(--red)"; }
        } else {
            try {
                // X√°c th·ª±c qua Supabase
                const r = await sb(`users?name=eq.${encodeURIComponent(u)}&select=name,pass,asset`);
                if(!r.ok || !r.data.length){ sfx('err'); msg.innerText="T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i"; msg.style.color="var(--red)"; return; }
                const srv = r.data[0];
                if(srv.pass !== p){ sfx('err'); msg.innerText="Sai m·∫≠t kh·∫©u"; msg.style.color="var(--red)"; return; }
                // Sync wallet t·ª´ server n·∫øu ch∆∞a c√≥ local
                let w = localStorage.getItem(`u_${u}`) ? JSON.parse(localStorage.getItem(`u_${u}`)) : null;
                if(!w) w = {pass:p, cash:safeFloat(srv.asset), stocks:{}, inbox:[{id:`sys_0`,from:"Terminal X",title:"Ch√†o m·ª´ng tr·ªü l·∫°i",body:"D·ªØ li·ªáu ƒë∆∞·ª£c kh√¥i ph·ª•c t·ª´ server.",time:Date.now(),read:false}], lastBC:Date.now()};
                w.pass = p;
                localStorage.setItem(`u_${u}`, JSON.stringify(w));
                me=u; wallet=w;
                if(!wallet.inbox) wallet.inbox=[];
                if(!wallet.lastBC) wallet.lastBC=0;
                localStorage.setItem("sess", u); enter();
            } catch(e){ sfx('err'); msg.innerText="L·ªói m·∫°ng: "+e.message; msg.style.color="var(--red)"; }
        }
    }

    function enter() {
        sfx('ok');
        document.getElementById("login-screen").style.display="none";
        document.getElementById("app").style.display="flex";
        document.getElementById("u-name").innerText=me;
        document.getElementById("btn-admin").style.display="block"; // T·∫•t c·∫£ th·∫•y n√∫t, nh∆∞ng openAdmin x√°c th·ª±c pass
        setInterval(loop, 1500);
        setInterval(syncIfChanged, 60000);
        setInterval(checkBroadcast, 15000);
        setInterval(checkBankruptcy, 8000);
        setInterval(checkGift, 20000);
        setInterval(checkP2PMail, 20000);
        setInterval(cleanExpiredNews, 10000); // c·∫≠p nh·∫≠t timer tin t·ª©c m·ªói 10 gi√¢y
        setTimeout(()=>{ checkBan(); setInterval(checkBan, 60000); }, 60000);
        // Load news t·ª´ GitHub r·ªìi m·ªõi generate
        loadNewsDb().then(() => {
            generateFakeNews();
            setInterval(generateFakeNews, 12000);
        });
        renderMail();
        window.dispatchEvent(new Event('resize'));
    }

    // ============================================================
    // MARKET LOOP ‚Äî t√≠nh local, kh√¥ng c·∫ßn g·ªçi server
    // ============================================================
    function loop() {
        const start = Date.now();
        data = getMarketData();
        data.forEach(s=>{
            if(!candles[s.code]) candles[s.code]=[];
            const l=candles[s.code];
            if(!l.length||l[l.length-1].time!==s.candle.time){l.push(s.candle);if(l.length>50)l.shift();}
            else l[l.length-1]=s.candle;
        });
        if(sel){updateD();draw();} renderList();
        document.getElementById("cash").innerText=wallet.cash.toFixed(2);
        updatePing(Date.now()-start);
    }
    function updatePing(ms){const d=document.getElementById("ping-dot"),t=document.getElementById("ping-val");t.innerText=ms;d.className=ms<50?"dot online":"dot lag";}

    // ============================================================
    // SYNC ‚Äî ch·ªâ ghi khi asset thay ƒë·ªïi ƒë·ªÉ ti·∫øt ki·ªám writes
    // ============================================================
    async function syncIfChanged() {
        if(!me) return;
        let t=wallet.cash; data.forEach(s=>{if(wallet.stocks[s.code]) t+=wallet.stocks[s.code]*s.price;});
        if(lastSyncedAsset !== null && Math.abs(t - lastSyncedAsset) < 1) return; // kh√¥ng ƒë·ªïi th√¨ b·ªè qua
        try {
            await sb("users", "POST", {name:me, asset:t});
            lastSyncedAsset = t;
        } catch(e){}
    }
    async function syncNow() {
        if(!me) return;
        let t=wallet.cash; data.forEach(s=>{if(wallet.stocks[s.code]) t+=wallet.stocks[s.code]*s.price;});
        try { await sb("users", "POST", {name:me, asset:t}); lastSyncedAsset=t; } catch(e){}
    }

    // ============================================================
    // BAN CHECK
    // ============================================================
    async function checkBan() {
        try {
            const r = await sb(`users?name=eq.${encodeURIComponent(me)}&select=name`);
            if(r.ok && r.data.length===0){
                showToast("C·∫¢NH B√ÅO","T√†i kho·∫£n ƒë√£ b·ªã BAN.",5000);
                setTimeout(()=>{localStorage.removeItem(`u_${me}`);localStorage.removeItem("sess");location.reload();},3000);
            }
        } catch(e){}
    }

    // ============================================================
    // LEADERBOARD
    // ============================================================
    async function getRank() {
        if(activeTab!=='rank') return;
        try {
            const r = await sb("users?select=name,asset&order=asset.desc&limit=50");
            document.getElementById("rank-list").innerHTML=(r.data||[]).map((p,i)=>`
                <div class="rank-item ${p.name===me?'rank-me':''}">
                    <div style="width:30px;text-align:center;font-weight:bold;">${i+1}</div>
                    <div style="flex:1;margin-left:10px;">
                        <div style="font-weight:bold;color:white;">${p.name} ${i===0?'üëë':''}</div>
                        <div style="font-size:12px;color:#888;">$${safeFloat(p.asset).toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                    </div>
                </div>`).join('');
        } catch(e){}
    }

    // ============================================================
    // BROADCAST
    // ============================================================
    async function checkBroadcast() {
        try {
            const r = await sb("broadcast?id=eq.bc_latest&select=*");
            if(r.ok && r.data.length>0){
                const m=r.data[0];
                if(m.time && m.time > wallet.lastBC){
                    wallet.inbox.unshift({id:m.id,from:"Admin",title:m.title,body:m.body,time:m.time,read:false});
                    wallet.lastBC=m.time;
                    showToast("TH√îNG B√ÅO","Tin nh·∫Øn t·ª´ h·ªá th·ªëng"); renderMail();
                    localStorage.setItem(`u_${me}`,JSON.stringify(wallet));
                }
            }
        } catch(e){}
    }

    // ============================================================
    // GIFT
    // ============================================================
    async function checkGift() {
        try {
            const r = await sb(`gifts?to=eq.${encodeURIComponent(me)}&select=id,amount`);
            if(r.ok && r.data.length>0){
                let total=0; r.data.forEach(g=>{total+=safeFloat(g.amount);});
                await sb(`gifts?to=eq.${encodeURIComponent(me)}`,"DELETE");
                wallet.cash=safeFloat(wallet.cash)+total;
                const type=total>0?"QU√Ä T·∫∂NG":"THU THU·∫æ";
                const msgText=total>0?`B·∫°n nh·∫≠n ƒë∆∞·ª£c: $${total}`:`B·∫°n b·ªã tr·ª´: $${Math.abs(total)}`;
                wallet.inbox.unshift({id:`gift_${Date.now()}`,from:"System",title:type,body:msgText,time:Date.now(),read:false});
                showToast(type,msgText); renderMail();
                localStorage.setItem(`u_${me}`,JSON.stringify(wallet));
                syncNow();
            }
        } catch(e){}
    }

    // ============================================================
    // MAIL P2P
    // ============================================================
    async function checkP2PMail() {
        try {
            const r = await sb(`mails?to=eq.${encodeURIComponent(me)}&select=*&order=time.asc`);
            if(r.ok && r.data.length>0){
                r.data.forEach(m=>{ if(!wallet.inbox.some(x=>x.id===m.id)) wallet.inbox.unshift({...m,read:false}); });
                await sb(`mails?to=eq.${encodeURIComponent(me)}`,"DELETE");
                localStorage.setItem(`u_${me}`,JSON.stringify(wallet));
                showToast("MAIL","B·∫°n c√≥ th∆∞ m·ªõi!"); renderMail();
            }
        } catch(e){}
    }
    async function sendP2PMail() {
        const to=document.getElementById("mail-to").value.trim(), sub=document.getElementById("mail-subj").value.trim(), body=document.getElementById("mail-content").value.trim();
        if(!to||!sub||!body) return showToast("TH√îNG B√ÅO","Nh·∫≠p ƒë·ªß th√¥ng tin");
        if(wallet.cash<10) return showToast("L·ªñI","Kh√¥ng ƒë·ªß ti·ªÅn ($10)");
        const id=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;
        const r = await sb("mails","POST",{id,to,from:me,title:sub,body,time:Date.now()});
        if(r.ok||r.status===201||r.status===200||r.status===204){
            wallet.cash-=10; showToast("TH√ÄNH C√îNG","ƒê√£ g·ª≠i!");
            document.getElementById("compose-modal").style.display="none";
            localStorage.setItem(`u_${me}`,JSON.stringify(wallet)); syncNow();
        } else showToast("L·ªñI","G·ª≠i th·∫•t b·∫°i");
    }

    // ============================================================
    // MAIL RENDER
    // ============================================================
    function renderMail() {
        const div=document.getElementById("mail-list"),empty=document.getElementById("empty-mail"),badge=document.getElementById("mail-badge");
        if(!wallet.inbox.length){div.innerHTML="";empty.style.display="block";badge.style.display="none";return;}
        empty.style.display="none";
        const unread=wallet.inbox.filter(m=>!m.read).length;
        badge.style.display=unread>0?"flex":"none"; badge.innerText=unread;
        div.innerHTML=wallet.inbox.map((m,i)=>`<div class="mail-item ${m.read?'':'unread'}" onclick="openMail(${i})"><div class="mail-icon">${m.from[0].toUpperCase()}</div><div class="mail-content"><div class="mail-sender">${m.from}</div><div class="mail-subject">${m.title}</div></div></div>`).join('');
    }
    function openMail(idx) {
        currentMailIdx=idx; const m=wallet.inbox[idx]; m.read=true;
        document.getElementById("mail-body-content").innerHTML=`<h3 style="margin-top:0">${m.title}</h3><div style="font-size:12px;color:#888;margin-bottom:20px">T·ª´: ${m.from} - ${new Date(m.time).toLocaleString()}</div><div>${m.body}</div>`;
        document.getElementById("mail-detail").style.display="flex";
        localStorage.setItem(`u_${me}`,JSON.stringify(wallet)); renderMail();
    }
    function closeMail(){document.getElementById("mail-detail").style.display="none";}
    function deleteCurrentMail(){if(currentMailIdx>-1){wallet.inbox.splice(currentMailIdx,1);localStorage.setItem(`u_${me}`,JSON.stringify(wallet));closeMail();renderMail();}}
    function openCompose(){document.getElementById("compose-modal").style.display="flex";}

    // ============================================================
    // ADMIN
    // ============================================================
    let allUsersCache = [];
    let cashMsgMode = 'none';
    let _adminVerified = false;  // c·ªù b·∫£o m·∫≠t runtime ‚Äî kh√¥ng l∆∞u localStorage
    let _adminToken = null;      // token ng·∫´u nhi√™n, reset m·ªói session

    // Sinh token ng·∫´u nhi√™n m·ªói l·∫ßn load ‚Äî kh√¥ng th·ªÉ ƒëo√°n hay gi·∫£ m·∫°o
    function _genToken() { return Math.random().toString(36).substr(2,9) + Date.now().toString(36) + Math.random().toString(36).substr(2,9); }

    // Guard: ki·ªÉm tra token + username th·∫≠t s·ª± match
    // K·ªÉ c·∫£ fake me b·∫±ng devtools v·∫´n kh√¥ng qua ƒë∆∞·ª£c v√¨ _adminToken bind v·ªõi session
    function _requireAdmin() {
        if(!_adminVerified || !_adminToken || typeof _adminToken !== 'string' || _adminToken.length < 10) {
            showToast("T·ª™ CH·ªêI","Kh√¥ng c√≥ quy·ªÅn admin");
            // Reset n·∫øu c√≥ ai ƒë√≥ c·ªë inject
            _adminVerified = false; _adminToken = null;
            return false;
        }
        return true;
    }

    // Ch·∫∑n devtools override _adminVerified t·ª´ console
    // D√πng Object.defineProperty ƒë·ªÉ kh√¥ng cho g√°n l·∫°i tr·ª±c ti·∫øp
    (function() {
        let _v = false, _t = null;
        Object.defineProperty(window, '_adminVerified', {
            get(){ return _v; },
            set(val){ if(typeof val === 'boolean') _v = val; },
            configurable: false
        });
        Object.defineProperty(window, '_adminToken', {
            get(){ return _t; },
            set(val){ if(typeof val === 'string' || val === null) _t = val; },
            configurable: false
        });
    })();

    async function openAdmin() {
        // B·∫•t k·ªÉ ai click n√∫t ADMIN ‚Äî ƒë·ªÅu ph·∫£i x√°c th·ª±c
        const p = await askInput("NH·∫¨P M·∫¨T KH·∫®U ADMIN:");
        if(!p) return;
        if(!_checkPass(p)) {
            sfx("err");
            showToast("‚õî SAI M·∫¨T KH·∫®U","Truy c·∫≠p b·ªã t·ª´ ch·ªëi", 4000);
            // Log c·∫£nh b√°o nh∆∞ng kh√¥ng l√†m g√¨ th√™m
            console.warn("[ADMIN] Truy c·∫≠p th·∫•t b·∫°i t·ª´:", me);
            return;
        }
        // X√°c th·ª±c th√†nh c√¥ng ‚Äî t·∫°o token session
        _adminVerified = true;
        _adminToken = _genToken();
        document.getElementById("admin-view").style.display="flex";
        adminTab("users");
    }

    // Khi ƒë√≥ng admin panel ‚Äî reset x√°c th·ª±c
    function closeAdmin() {
        _adminVerified = false;
        _adminToken = null;
        document.getElementById("admin-view").style.display="none";
    }

    function adminTab(tab) {
        ['users','cash','news','bc','subadmin'].forEach(t => {
            document.getElementById(`admv-${t}`).style.display = t===tab ? 'block' : 'none';
            const btn = document.getElementById(`admt-${t}`);
            if(btn){ btn.style.color = t===tab ? 'white' : '#666'; btn.style.borderBottom = t===tab ? '2px solid var(--red)' : '2px solid transparent'; }
        });
        if(tab==='users') loadAdminUsers();
        if(tab==='news') renderAdminNews();
        if(tab==='subadmin') renderSubAdminList();
    }

    async function loadAdminUsers() {
        if(!_requireAdmin()) return;
        const d=document.getElementById("admin-user-list"); d.innerHTML="<div style='padding:15px;color:#666;text-align:center;'>ƒêang t·∫£i...</div>";
        try {
            const r = await sb("users?select=name,asset&order=asset.desc");
            allUsersCache = r.data || [];
            renderUserList(allUsersCache);
        } catch(e){d.innerHTML="<div style='padding:15px;color:red;'>L·ªói k·∫øt n·ªëi</div>";}
    }

    function renderUserList(users) {
        const d = document.getElementById("admin-user-list");
        if(!users.length){d.innerHTML="<div style='padding:15px;color:#666;text-align:center;'>Kh√¥ng c√≥ user</div>";return;}
        d.innerHTML = users.map((x,i)=>`
        <div style="display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid #1a1a1a;">
            <div style="width:24px;color:#555;font-size:11px;">${i+1}</div>
            <div style="flex:1;cursor:pointer;" onclick="selectUserForCash('${x.name}')">
                <div style="font-weight:bold;color:white;font-size:13px;">${x.name}</div>
                <div style="font-size:11px;color:#00ff88;">$${safeFloat(x.asset).toLocaleString(undefined,{maximumFractionDigits:0})}</div>
            </div>
            <div style="display:flex;gap:5px;">
                <button onclick="quickGrant('${x.name}')" style="background:#1f6feb;color:white;border:none;padding:6px 8px;border-radius:4px;font-size:12px;">üí∞</button>
                <button onclick="delUser('${x.name}')" style="background:#500;color:white;border:none;padding:6px 8px;border-radius:4px;font-size:12px;">BAN</button>
            </div>
        </div>`).join('');
    }

    function filterUsers() {
        const q = document.getElementById("admin-search").value.toLowerCase();
        renderUserList(allUsersCache.filter(u => u.name.toLowerCase().includes(q)));
    }

    function selectUserForCash(name) {
        document.getElementById("cash-user").value = name;
        adminTab('cash');
    }

    async function quickGrant(name) {
        document.getElementById("cash-user").value = name;
        adminTab('cash');
    }

    // --- CASH TAB ---
    function setCashMsg(mode) {
        cashMsgMode = mode;
        ['none','preset','custom'].forEach(m => {
            document.getElementById(`msgbtn-${m}`).style.background = m===mode ? 'var(--blue)' : '#333';
        });
        document.getElementById("cash-preset-area").style.display = mode==='preset' ? 'block' : 'none';
        document.getElementById("cash-custom-area").style.display  = mode==='custom' ? 'block' : 'none';
    }

    async function doGrantCash(sign) {
        if(!_requireAdmin()) return;
        const user = document.getElementById("cash-user").value.trim();
        const amount = parseFloat(document.getElementById("cash-amount").value);
        if(!user) return showToast("L·ªñI","Ch∆∞a ch·ªçn user");
        if(isNaN(amount)||amount<=0) return showToast("L·ªñI","S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá");

        const finalAmount = Math.abs(amount) * sign;

        // -- Ghi gift v√†o Supabase (CH·ªà 1 l·∫ßn) --
        const giftId = `gift_${user}_${Date.now()}_${Math.random().toString(36).substr(2,4)}`;
        const gr = await sb("gifts","POST",{id:giftId, to:user, amount:finalAmount});
        if(!gr.ok && gr.status!==201 && gr.status!==200 && gr.status!==204) {
            return showToast("L·ªñI","Ghi th·∫•t b·∫°i: "+gr.status);
        }

        // -- G·ª≠i mail th√¥ng b√°o (CH·ªà 1 l·∫ßn, ch·ªâ khi cashMsgMode !== none) --
        if(cashMsgMode !== 'none') {
            let msgTitle = '', msgBody = '';
            if(cashMsgMode === 'preset') {
                msgTitle = document.getElementById("cash-preset-title").value.trim()
                    || (finalAmount>0 ? "Nhan tien tu Admin" : "Bi tru tien boi Admin");
                msgBody = document.getElementById("cash-preset-select").value;
            } else {
                msgTitle = document.getElementById("cash-custom-title").value.trim()
                    || (finalAmount>0 ? "Nhan tien tu Admin" : "Bi tru tien boi Admin");
                msgBody = document.getElementById("cash-custom-msg").value.trim()
                    || (finalAmount>0 ? "Ban nhan duoc tien tu Admin." : "Ban bi tru tien boi Admin.");
            }
            const mailId = `mail_${user}_${Date.now()}_${Math.random().toString(36).substr(2,4)}`;
            await sb("mails","POST",{id:mailId, to:user, from:"Admin", title:msgTitle, body:msgBody, time:Date.now()});
        }

        showToast("THANH CONG", finalAmount>0?`ƒê√£ t·∫∑ng $${amount} cho ${user}`:`ƒê√£ thu $${amount} t·ª´ ${user}`);
        document.getElementById("cash-amount").value = "";
        document.getElementById("cash-user").value = "";
    }

    async function delUser(n) {
        if(!_requireAdmin()) return;
        const c=await askInput(`G√µ "BAN" ƒë·ªÉ ban ${n}`);
        if(c==='BAN'){
            await sb(`users?name=eq.${encodeURIComponent(n)}`,"DELETE");
            showToast("TH√îNG B√ÅO",`ƒê√£ ban ${n}`); loadAdminUsers();
        }
    }

    // --- NEWS TAB ---
    function renderAdminNews() {
        const el = document.getElementById("admin-news-list");
        if(!news.length){el.innerHTML="<div style='color:#555;font-size:12px;padding:5px;'>Ch∆∞a c√≥ tin t·ª©c</div>";return;}
        el.innerHTML = news.map((n,i)=>{
            const tags = (n.stocks && n.stocks.length > 0) ? ` [${n.stocks.join(',')}]` : '';
            return `<div style="display:flex;align-items:center;padding:5px;border-bottom:1px solid #222;gap:8px;">
                <div style="width:8px;height:8px;border-radius:50%;background:${n.b>0?'var(--green)':n.b<0?'var(--red)':'#555'};flex-shrink:0;"></div>
                <div style="flex:1;font-size:11px;color:#ccc;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${n.t}<span style="color:#555;font-size:10px;">${tags}</span></div>
                <button onclick="deleteNews(${i})" style="background:none;border:none;color:#555;font-size:12px;padding:0 3px;flex-shrink:0;">‚úï</button>
            </div>`;
        }).join('');
    }

    function setNewsSentiment(impact, vol, dur) {
        document.getElementById("news-impact-val").value = impact;
        document.getElementById("news-vol-val").value = vol;
        document.getElementById("news-dur-val").value = dur;
        document.getElementById("news-sentiment-select").value = impact > 0 ? '1' : impact < 0 ? '-1' : '0';
    }

    function toggleChip(el) {
        const isActive = el.style.background !== 'rgb(17, 17, 17)' && el.style.background !== '#111' && el.style.background !== '';
        if(el.dataset.code === 'ALL') {
            // Ch·ªçn t·∫•t c·∫£ ho·∫∑c b·ªè t·∫•t c·∫£
            const chips = document.querySelectorAll('.stock-chip:not([data-code="ALL"])');
            const allSelected = !isActive;
            chips.forEach(c => {
                c.style.background = allSelected ? '#1a3a1a' : '#111';
                c.style.borderColor = allSelected ? 'var(--green)' : '#444';
                c.style.color = allSelected ? 'var(--green)' : '#888';
            });
            el.style.background = allSelected ? '#1a3a1a' : '#111';
            el.style.borderColor = allSelected ? 'var(--green)' : '#555';
            el.style.color = allSelected ? 'var(--green)' : '#888';
        } else {
            el.style.background = isActive ? '#111' : '#1a3a1a';
            el.style.borderColor = isActive ? '#444' : 'var(--green)';
            el.style.color = isActive ? '#888' : 'var(--green)';
            // B·ªè ch·ªçn "T·∫§T C·∫¢" n·∫øu b·ªè 1 c√°i
            const allChip = document.querySelector('.stock-chip[data-code="ALL"]');
            if(isActive && allChip) { allChip.style.background='#111'; allChip.style.borderColor='#555'; allChip.style.color='#888'; }
        }
    }

    function getSelectedChips() {
        const allChip = document.querySelector('.stock-chip[data-code="ALL"]');
        const isAllSelected = allChip && allChip.style.background === 'rgb(26, 58, 26)';
        if(isAllSelected) return ['VN-INDEX','VIN','FPT','HPG','DIG','VTB'];
        const selected = [];
        document.querySelectorAll('.stock-chip:not([data-code="ALL"])').forEach(c => {
            if(c.style.background === 'rgb(26, 58, 26)') selected.push(c.dataset.code);
        });
        return selected;
    }

    async function generateAINews() {
        if(!_requireAdmin()) return;
        const btn = document.getElementById("ai-news-btn");
        btn.innerText = "ƒêang t·∫°o..."; btn.disabled = true;
        try {
            const stocks = getSelectedChips();
            const sentiment = document.getElementById("news-sentiment-select").value;
            const context = stocks.length > 0 ? `li√™n quan ƒë·∫øn ${stocks.join(', ')}` : 'th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam';
            const prompt = `Vi·∫øt 1 tin t·ª©c ch·ª©ng kho√°n ng·∫Øn (1 c√¢u, t·ªëi ƒëa 15 t·ª´) theo h∆∞·ªõng ${sentiment === '1' ? 't√≠ch c·ª±c l·∫°c quan' : sentiment === '-1' ? 'ti√™u c·ª±c bi quan' : 'trung l·∫≠p'} ${context}. Ch·ªâ tr·∫£ v·ªÅ n·ªôi dung tin, kh√¥ng gi·∫£i th√≠ch.`;
            const resp = await fetch("https://api.anthropic.com/v1/messages", {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify({model:"claude-sonnet-4-5-20250929", max_tokens:100, messages:[{role:"user",content:prompt}]})
            });
            const j = await resp.json();
            const aiText = j.content?.[0]?.text?.trim() || '';
            if(aiText) document.getElementById("custom-news-text").value = aiText;
            showToast("AI","ƒê√£ t·∫°o tin t·ª©c!");
        } catch(e){ showToast("L·ªñI","Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c AI"); }
        btn.innerText = "‚ú® AI T·∫°o tin"; btn.disabled = false;
    }

    function addCustomNews() {
        if(!_requireAdmin()) return;
        const titleInp = document.getElementById("news-title-inp").value.trim();
        const rawText = document.getElementById("custom-news-text").value.trim();
        if(!rawText && !titleInp) return showToast("L·ªñI","Nh·∫≠p n·ªôi dung tin t·ª©c");

        const impactVal  = parseFloat(document.getElementById("news-impact-val").value) || 0;
        const volatility = parseFloat(document.getElementById("news-vol-val").value) || 5;
        const duration   = parseFloat(document.getElementById("news-dur-val").value) || 5;
        const selectedStocks = getSelectedChips();

        pushNews({
            t: titleInp || rawText,
            body: titleInp ? rawText : '',
            b: impactVal,
            v: volatility,
            d: duration,
            stocks: selectedStocks,
            isCustom: true,
        });

        document.getElementById("custom-news-text").value = "";
        document.getElementById("news-title-inp").value = "";
        document.getElementById("news-impact-val").value = "0";
        document.getElementById("news-vol-val").value = "5";
        document.getElementById("news-dur-val").value = "5";
        document.querySelectorAll('.stock-chip').forEach(c=>{
            c.style.background='#111';
            c.style.borderColor = c.dataset.code==='ALL' ? '#555' : '#444';
            c.style.color='#888';
        });
        renderAdminNews();
        const stockLabel = selectedStocks.length === 0 ? 'to√†n th·ªã tr∆∞·ªùng' : selectedStocks.join(', ');
        showToast("TH√ÄNH C√îNG", `ƒê√£ ƒëƒÉng tin ‚Äî √°p d·ª•ng: ${stockLabel}`);
    }

    function deleteNews(idx) {
        news.splice(idx,1);
        renderAdminNews();
        if(activeTab==='news') renderNewsPage();
    }

    function clearAllNews() {
        if(!_requireAdmin()) return;
        news=[];
        renderAdminNews();
        if(activeTab==='news') renderNewsPage();
        showToast("TH√îNG B√ÅO","ƒê√£ x√≥a t·∫•t c·∫£ tin t·ª©c");
    }

    // --- BROADCAST ---
    async function adminBroadcast() {
        if(!_requireAdmin()) return;
        const t=document.getElementById("bc-title").value.trim(), b=document.getElementById("bc-body").value.trim();
        if(!t||!b) return showToast("L·ªñI","Nh·∫≠p ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung");
        await sb("broadcast","POST",{id:"bc_latest",title:t,body:b,time:Date.now()});
        showToast("TH√ÄNH C√îNG","ƒê√£ ph√°t loa to√†n server!");
        document.getElementById("bc-title").value="";
        document.getElementById("bc-body").value="";
    }

    // --- USER DROPDOWN cho cash tab ---
    function showUserDropdown() {
        if(!_requireAdmin()) return;
        filterCashUsers();
    }
    function filterCashUsers() {
        const q = document.getElementById("cash-user").value.toLowerCase();
        const dd = document.getElementById("cash-user-dropdown");
        const filtered = allUsersCache.filter(u => u.name.toLowerCase().includes(q));
        if(!filtered.length){ dd.style.display='none'; return; }
        dd.style.display='block';
        dd.innerHTML = filtered.map(u=>`
            <div onclick="selectCashUser('${u.name}')" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #333;font-size:13px;color:white;"
                onmouseover="this.style.background='#2a2a2a'" onmouseout="this.style.background='transparent'">
                <span style="font-weight:bold;">${u.name}</span>
                <span style="color:#00ff88;font-size:11px;margin-left:8px;">$${safeFloat(u.asset).toLocaleString(undefined,{maximumFractionDigits:0})}</span>
            </div>`).join('');
        // ƒê√≥ng dropdown khi click ra ngo√†i
        setTimeout(()=>{ document.addEventListener('click', closeCashDropdown, {once:true}); }, 0);
    }
    function closeCashDropdown(e) {
        const dd = document.getElementById("cash-user-dropdown");
        if(dd && !dd.contains(e.target)) dd.style.display='none';
    }
    function selectCashUser(name) {
        document.getElementById("cash-user").value = name;
        document.getElementById("cash-user-dropdown").style.display='none';
    }

    // --- PH·ª§ ADMIN ---
    let subAdminList = JSON.parse(localStorage.getItem('_subAdmins')||'[]');
    let subAdminSystemOn = localStorage.getItem('_subAdminSys') === '1';
    let subAdminPerms = JSON.parse(localStorage.getItem('_subAdminPerms')||'{"view-users":true,"cash":false,"news":false,"broadcast":false,"ban":false}');

    function saveSubAdmins() {
        localStorage.setItem('_subAdmins', JSON.stringify(subAdminList));
        localStorage.setItem('_subAdminSys', subAdminSystemOn ? '1' : '0');
    }
    function savePerms() {
        subAdminPerms = {
            'view-users': document.getElementById('perm-view-users').checked,
            'cash':       document.getElementById('perm-cash').checked,
            'news':       document.getElementById('perm-news').checked,
            'broadcast':  document.getElementById('perm-broadcast').checked,
            'ban':        document.getElementById('perm-ban').checked,
        };
        localStorage.setItem('_subAdminPerms', JSON.stringify(subAdminPerms));
    }
    function loadPerms() {
        ['view-users','cash','news','broadcast','ban'].forEach(p => {
            const el = document.getElementById(`perm-${p}`);
            if(el) el.checked = subAdminPerms[p] || false;
        });
    }
    function hasPerm(perm) {
        // Admin ch√≠nh lu√¥n c√≥ t·∫•t c·∫£ quy·ªÅn
        if(_adminVerified) return true;
        // Ph·ª• admin ki·ªÉm tra quy·ªÅn
        if(isSubAdmin()) return subAdminPerms[perm] === true;
        return false;
    }
    function isSubAdmin() {
        return subAdminSystemOn && subAdminList.includes(me);
    }

    function renderSubAdminList() {
        if(!_requireAdmin()) return;
        loadPerms();
        const dot = document.getElementById("sub-system-dot");
        const btn = document.getElementById("sub-system-btn");
        if(subAdminSystemOn){ btn.style.background='#1f6feb'; dot.style.left='22px'; dot.style.background='white'; }
        else { btn.style.background='#333'; dot.style.left='2px'; dot.style.background='#666'; }
        const el = document.getElementById("subadmin-list");
        if(!subAdminList.length){ el.innerHTML="<div style='color:#555;font-size:12px;padding:4px;'>Ch∆∞a c√≥ ph·ª• admin</div>"; return; }
        el.innerHTML = subAdminList.map((n,i)=>`
            <div style="display:flex;align-items:center;padding:6px 4px;gap:8px;border-bottom:1px solid #222;">
                <div style="flex:1;font-size:12px;color:${subAdminSystemOn?'white':'#666'};">${n}</div>
                <div style="font-size:10px;padding:2px 6px;border-radius:3px;background:${subAdminSystemOn?'#0f3318':'#1a1a1a'};color:${subAdminSystemOn?'var(--green)':'#555'};">${subAdminSystemOn?'ACTIVE':'T·∫ÆT'}</div>
                <button onclick="removeSubAdmin(${i})" style="background:none;border:none;color:#555;cursor:pointer;font-size:14px;">√ó</button>
            </div>`).join('');
    }

    function toggleSubAdminSystem() {
        if(!_requireAdmin()) return;
        subAdminSystemOn = !subAdminSystemOn;
        saveSubAdmins();
        renderSubAdminList();
        showToast("PH·ª§ ADMIN", subAdminSystemOn ? "H·ªá th·ªëng ph·ª• admin: B·∫¨T" : "H·ªá th·ªëng ph·ª• admin: T·∫ÆT");
    }

    function addSubAdmin() {
        if(!_requireAdmin()) return;
        const name = document.getElementById("subadmin-name-inp").value.trim();
        if(!name) return showToast("L·ªñI","Nh·∫≠p t√™n user");
        if(name === 'minh') return showToast("L·ªñI","Admin ch√≠nh kh√¥ng c·∫ßn th√™m");
        if(subAdminList.includes(name)) return showToast("L·ªñI","ƒê√£ c√≥ trong danh s√°ch");
        subAdminList.push(name);
        saveSubAdmins();
        document.getElementById("subadmin-name-inp").value="";
        renderSubAdminList();
        showToast("THANH CONG",`Da them ${name} lam phu admin`);
    }

    function removeSubAdmin(idx) {
        if(!_requireAdmin()) return;
        const name = subAdminList[idx];
        subAdminList.splice(idx,1);
        saveSubAdmins();
        renderSubAdminList();
        showToast("THONG BAO",`Da xoa ${name}`);
    }

    async function resetAllUsers() {
        if(!_requireAdmin()) return;
        const c=await askInput(`G√µ "XOAHET" ƒë·ªÉ x√≥a TO√ÄN B·ªò:`);
        if(c==='XOAHET'){
            await sb("users?name=neq.____x____","DELETE");
            await sb("mails?id=neq.____x____","DELETE");
            await sb("gifts?id=neq.____x____","DELETE");
            await sb("broadcast?id=neq.____x____","DELETE");
            showToast("TH√îNG B√ÅO","ƒê√£ x√≥a to√†n b·ªô"); loadAdminUsers();
        }
    }

    // ============================================================
    // BANKRUPTCY & ACCOUNT UTILS
    // ============================================================
    function checkBankruptcy() {
        if(!data.length) return;
        let t=wallet.cash; data.forEach(s=>{if(wallet.stocks[s.code]) t+=wallet.stocks[s.code]*s.price;});
        if(t<10&&!wallet.inbox.some(m=>m.title==="C·∫¢NH B√ÅO PH√Å S·∫¢N"&&(Date.now()-m.time<60000))){
            wallet.inbox.unshift({id:`sys_${Date.now()}`,from:"Terminal X",title:"C·∫¢NH B√ÅO PH√Å S·∫¢N",body:`T√†i s·∫£n d∆∞·ªõi $10.<br><button onclick="resetAccount()">RESET ($250)</button>`,time:Date.now(),read:false});
            renderMail();
        }
    }
    window.resetAccount = async function() {
        const c=await askInput("G√µ 'RESET' ƒë·ªÉ x√°c nh·∫≠n:");
        if(c==='RESET'){wallet.cash=250;wallet.stocks={};wallet.inbox=[];localStorage.setItem(`u_${me}`,JSON.stringify(wallet));closeMail();renderMail();syncNow();}
    }
    async function forgotPass(){const c=await askInput("G√µ 'DEL' ƒë·ªÉ x√≥a d·ªØ li·ªáu:");if(c==='DEL'){localStorage.clear();location.reload();}}
    async function changePassword() {
        const o=document.getElementById("old-pass").value, n=document.getElementById("new-pass").value;
        if(!o||!n) return;
        if(o!==wallet.pass) return showToast("L·ªñI","M·∫≠t kh·∫©u c≈© sai");
        wallet.pass=n;
        await sb("users","POST",{name:me,pass:n});
        localStorage.setItem(`u_${me}`,JSON.stringify(wallet));
        showToast("TH√ÄNH C√îNG","ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u!"); logout();
    }

    // ============================================================
    // TRADE
    // ============================================================
    document.getElementById("trade-amount").addEventListener("input",function(){
        const qty=parseFloat(this.value);
        if(sel&&data.length){const s=data.find(x=>x.code===sel);document.getElementById("trade-estimate").innerText=`∆Ø·ªõc t√≠nh: $${isNaN(qty*s.price)?'0.00':(qty*s.price).toFixed(2)}`;}
    });
    async function trade(t) {
        let qty=parseFloat(document.getElementById("trade-amount").value);
        if(!qty||qty<=0){const inp=await askInput("Nh·∫≠p s·ªë l∆∞·ª£ng:");qty=parseFloat(inp);}
        if(!qty||qty<=0) return showToast("L·ªñI","S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá");
        const s=data.find(x=>x.code===sel), cost=qty*s.price;
        if(t==='buy'){if(cost>wallet.cash) return showToast("L·ªñI","Thi·∫øu ti·ªÅn");wallet.cash-=cost;wallet.stocks[sel]=(wallet.stocks[sel]||0)+qty;}
        else{if(qty>(wallet.stocks[sel]||0)) return showToast("L·ªñI","Thi·∫øu CP");wallet.stocks[sel]-=qty;wallet.cash+=cost;}
        sfx('ok'); localStorage.setItem(`u_${me}`,JSON.stringify(wallet)); syncNow();
    }

    // ============================================================
    // CHART & RENDER
    // ============================================================
    function renderList() {
        const div=document.getElementById("list");
        if(div.childElementCount!==data.length){
            div.innerHTML=data.map(s=>`<div class="stock-item" onclick="openDetail('${s.code}')" id="st-${s.code}"><div><div style="font-weight:900;font-size:16px;color:white">${s.code}</div><div style="font-size:11px;color:#888">${(wallet.stocks[s.code]||0).toFixed(0)} CP</div></div><div style="text-align:right"><div class="price-val" style="font-size:16px;font-weight:bold;">${s.price.toFixed(2)}</div></div></div>`).join('');
        } else {
            data.forEach(s=>{const el=document.getElementById(`st-${s.code}`);if(el){const up=s.candle.close>=s.candle.open;const p=el.querySelector(".price-val");p.innerText=s.price.toFixed(2);p.style.color=up?"var(--green)":"var(--red)";}});
        }
    }
    // ‚îÄ‚îÄ‚îÄ NEWS ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let newsDb = [];        // tin t·ª´ GitHub JSON
    let activeNewsEvents = []; // tin ƒëang t√°c ƒë·ªông (c√≥ timer)
    let newsDbLoaded = false;

    async function loadNewsDb() {
        try {
            const r = await fetch("https://raw.githubusercontent.com/minhReal/CSimu/refs/heads/main/news.json?"+Date.now());
            newsDb = await r.json();
            newsDbLoaded = true;
        } catch(e) { newsDb = []; newsDbLoaded = false; }
    }

    function weightedRandom(items) {
        const total = items.reduce((s,x) => s + (x.r||10), 0);
        let rand = Math.random() * total;
        for(const item of items) { rand -= (item.r||10); if(rand <= 0) return item; }
        return items[items.length-1];
    }

    function generateFakeNews() {
        if(!newsDbLoaded || !newsDb.length) return;
        const pick = weightedRandom(newsDb);
        pushNews(pick);
    }

    function pushNews(item) {
        const now = Date.now();
        const n = {
            id: now + '_' + Math.random().toString(36).substr(2,4),
            t: item.t,
            b: item.b || 0,         // t√°c ƒë·ªông % (+ t·ªët, - x·∫•u)
            v: item.v || 5,         // volatility th√™m
            d: item.d || 10,        // th·ªùi gian t√°c ƒë·ªông (ph√∫t)
            stocks: item.stocks || [],
            time: new Date().toLocaleTimeString(),
            expiresAt: now + (item.d || 10) * 60 * 1000,
            isCustom: item.isCustom || false,
            aiGen: item.aiGen || false,
        };
        // Th√™m v√†o active events n·∫øu c√≥ t√°c ƒë·ªông
        if(n.b !== 0 || n.v !== 5) {
            activeNewsEvents.unshift(n);
            if(activeNewsEvents.length > 10) activeNewsEvents.pop();
        }
        news.unshift(n);
        if(news.length > 30) news.pop();
        if(activeTab==='news') renderNewsPage();
        tick();
    }

    // Tick ƒë·∫øm th·ªùi gian v√† lo·∫°i b·ªè tin h·∫øt h·∫°n
    function cleanExpiredNews() {
        const now = Date.now();
        activeNewsEvents = activeNewsEvents.filter(n => n.expiresAt > now);
        if(activeTab==='news') renderNewsPage(); // update timers
    }
    function renderNewsPage(){
        const now = Date.now();
        document.getElementById("news-list").innerHTML = news.map(n => {
            const impact = n.b || 0;
            const impactColor = impact > 0 ? 'var(--green)' : impact < 0 ? 'var(--red)' : '#666';
            const impactLabel = impact > 10 ? 'R·∫§T T√çCH C·ª∞C' : impact > 0 ? 'T√çCH C·ª∞C' : impact < -10 ? 'R·∫§T TI√äU C·ª∞C' : impact < 0 ? 'TI√äU C·ª∞C' : 'TH·ªä TR∆Ø·ªúNG';
            const impactSign = impact > 0 ? '+' : '';
            // Timer ƒë·∫øm ng∆∞·ª£c
            let timerHTML = '';
            if(n.expiresAt) {
                const remaining = Math.max(0, n.expiresAt - now);
                if(remaining > 0) {
                    const mins = Math.floor(remaining / 60000);
                    const secs = Math.floor((remaining % 60000) / 1000);
                    const pct = remaining / (n.d * 60000) * 100;
                    timerHTML = `
                        <div style="margin-top:6px;">
                            <div style="display:flex;justify-content:space-between;font-size:9px;color:#666;margin-bottom:3px;">
                                <span>C√≤n t√°c ƒë·ªông: ${mins}p ${secs}s</span>
                                <span style="color:${impactColor};">Bi·∫øn ƒë·ªông: ${impactSign}${impact}%</span>
                            </div>
                            <div style="height:3px;background:#222;border-radius:2px;">
                                <div style="height:100%;width:${pct}%;background:${impactColor};border-radius:2px;transition:width 1s;"></div>
                            </div>
                        </div>`;
                } else {
                    timerHTML = `<div style="font-size:9px;color:#444;margin-top:4px;">ƒê√£ h·∫øt t√°c ƒë·ªông</div>`;
                }
            }
            // Stock tags
            const stockTags = (n.stocks && n.stocks.length > 0)
                ? n.stocks.map(s => `<span style="font-size:9px;background:#1a2a1a;color:var(--green);padding:1px 5px;border-radius:3px;margin-right:3px;border:1px solid #2a4a2a;">${s}</span>`).join('')
                : '';
            // Badges
            const badges = [
                n.aiGen ? `<span style="font-size:8px;background:#1a1a3a;color:#7777ff;padding:1px 4px;border-radius:2px;">AI</span>` : '',
                n.isCustom ? `<span style="font-size:8px;background:#2a1a00;color:var(--gold);padding:1px 4px;border-radius:2px;">CUSTOM</span>` : '',
            ].filter(Boolean).join(' ');
            return `<div class="news-card" style="border-left-color:${impactColor};border-left-width:3px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                    <div style="display:flex;align-items:center;gap:5px;">
                        <span class="news-time">${n.time}</span>
                        ${badges}
                    </div>
                    <div style="font-size:9px;color:${impactColor};font-weight:bold;padding:1px 6px;border:1px solid ${impactColor};border-radius:3px;">${impactLabel}</div>
                </div>
                ${stockTags ? `<div style="margin-bottom:5px;">${stockTags}</div>` : ''}
                <div style="color:#eee;font-weight:bold;line-height:1.4;">${n.t}</div>
                ${n.body ? `<div style="color:#999;font-size:11px;margin-top:4px;line-height:1.4;">${n.body}</div>` : ''}
                ${timerHTML}
            </div>`;
        }).join('') || '<div style="text-align:center;color:#444;padding:30px;font-size:13px;">Ch∆∞a c√≥ tin t·ª©c</div>';
    }
    function tick(){if(!news.length)return;const n=news[0];const el=document.getElementById("mini-news-ticker");el.innerText=`üì∞ ${n.t}`;el.className=`mini-news ${n.b>0?'pos':'neg'}`;}
    function openDetail(c){sfx('click');sel=c;document.getElementById("detail-view").classList.add("active");initChart();updateD();tick();}
    function closeDetail(){sfx('click');sel=null;document.getElementById("detail-view").classList.remove("active");}
    function updateD(){const s=data.find(x=>x.code===sel);document.getElementById("d-code").innerText=s.code;document.getElementById("d-price").innerText=s.price.toFixed(2);document.getElementById("d-owned").innerText=(wallet.stocks[sel]||0).toFixed(0);document.getElementById("d-price").style.color=(candles[sel]?.at(-1).close>=candles[sel]?.at(-1).open)?"var(--green)":"var(--red)";}
    window.addEventListener('resize',()=>{if(sel){initChart();draw();}});
    let ctx;
    function initChart(){const c=document.getElementById("chart");const rect=c.parentElement.getBoundingClientRect();const dpr=window.devicePixelRatio||1;c.width=rect.width*dpr;c.height=rect.height*dpr;ctx=c.getContext("2d");ctx.scale(dpr,dpr);}
    function calculateSmartGrid(min,max){const range=max-min;const roughStep=range/5;const magnitude=Math.pow(10,Math.floor(Math.log10(roughStep)));const normalizedStep=roughStep/magnitude;return(normalizedStep<1.5?1:normalizedStep<3?2:normalizedStep<7?5:10)*magnitude;}
    function draw(){
        if(!sel||!candles[sel]) return; const d=candles[sel]; if(!d.length) return;
        const rect=document.getElementById("chart").parentElement.getBoundingClientRect();
        const W=rect.width,H=rect.height; ctx.clearRect(0,0,W,H);
        let min=Infinity,max=-Infinity; d.forEach(x=>{if(x.low<min)min=x.low;if(x.high>max)max=x.high;});
        const padding=(max-min)*0.1; min-=padding; max+=padding;
        const step=calculateSmartGrid(min,max); const startY=Math.ceil(min/step)*step; const py=20;
        const gy=v=>H-py-((v-min)/(max-min))*(H-py*2);
        ctx.fillStyle="#444"; ctx.font="10px monospace"; ctx.textAlign="right"; ctx.strokeStyle="#222"; ctx.lineWidth=1;
        for(let v=startY;v<=max;v+=step){const y=gy(v);ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();ctx.fillText(v.toFixed(step<1?2:0),W-5,y-2);}
        let cw=(W-30)/50; if(cw>40) cw=40;
        if(chartType==='candle'){d.forEach((c,i)=>{const x=i*cw+10,col=c.close>=c.open?"#00ff88":"#ff3b3b";ctx.strokeStyle=col;ctx.fillStyle=col;ctx.beginPath();ctx.moveTo(x+cw/2,gy(c.high));ctx.lineTo(x+cw/2,gy(c.low));ctx.stroke();const h=Math.abs(gy(c.open)-gy(c.close))||1;ctx.fillRect(x+1,Math.min(gy(c.open),gy(c.close)),cw-2,h);});}
        else{ctx.lineWidth=2;for(let i=0;i<d.length-1;i++){const x1=i*cw+10+cw/2,y1=gy(d[i].close),x2=(i+1)*cw+10+cw/2,y2=gy(d[i+1].close);ctx.beginPath();ctx.strokeStyle=d[i+1].close>=d[i].close?"#00ff88":"#ff3b3b";ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();}}
        const ly=gy(d[d.length-1].close); ctx.strokeStyle="rgba(255,255,255,0.4)"; ctx.setLineDash([2,2]); ctx.beginPath(); ctx.moveTo(0,ly); ctx.lineTo(W,ly); ctx.stroke(); ctx.setLineDash([]);
        ctx.fillStyle=d[d.length-1].close>=d[d.length-1].open?"#00ff88":"#ff3b3b"; ctx.fillRect(W-35,ly-8,35,16); ctx.fillStyle="black"; ctx.fillText(d[d.length-1].close.toFixed(2),W-2,ly+3);
    }

    // ============================================================
    // UTILS
    // ============================================================
    function tab(id){document.querySelectorAll('.view-content').forEach(e=>e.classList.add('hidden'));document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));document.getElementById(`tab-${id}`).classList.remove('hidden');event.target.classList.add('active');sfx('click');activeTab=id;if(id==='rank')getRank();if(id==='news')renderNewsPage();}
    function logout(){localStorage.removeItem("sess");location.reload();}
    function changeChartType(){chartType=document.getElementById("chart-type-select").value;localStorage.setItem("chart_type",chartType);if(sel)draw();}
    function openSettings(){document.getElementById("settings-modal").style.display='flex';}
</script>
</body>
</html>
